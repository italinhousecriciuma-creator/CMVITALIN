<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0f1c">
    <title>CMV Control - Ital'in House</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --bg-hover: #243049;
            --green: #10b981;
            --red: #ef4444;
            --yellow: #f59e0b;
            --blue: #3b82f6;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --cyan: #06b6d4;
            --orange: #f97316;
            --text: #f1f5f9;
            --text2: #94a3b8;
            --text3: #64748b;
            --border: #2d3a52;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text); min-height: 100vh; padding-bottom: 100px; }
        
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 0.7rem 1rem; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 0.5rem; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--green), var(--blue)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
        .logo h1 { font-size: 0.95rem; font-weight: 700; }
        .logo span { font-size: 0.55rem; color: var(--text3); display: block; }
        .header-right { display: flex; align-items: center; gap: 0.5rem; }
        .header-date { font-family: 'Space Mono', monospace; color: var(--green); font-size: 0.65rem; }
        .sync-status { display: flex; align-items: center; gap: 0.25rem; font-size: 0.55rem; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .sync-status.online { background: rgba(16,185,129,0.2); color: var(--green); }
        .sync-status.offline { background: rgba(239,68,68,0.2); color: var(--red); }
        
        .nav { background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 48px; z-index: 99; }
        .nav-content { display: flex; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding: 0 0.5rem; }
        .nav-content::-webkit-scrollbar { display: none; }
        .nav-btn { background: none; border: none; color: var(--text2); padding: 0.7rem 0.7rem; font-family: inherit; font-size: 0.65rem; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; transition: all 0.15s; flex-shrink: 0; }
        .nav-btn:hover, .nav-btn:active { color: var(--text); background: var(--bg-hover); }
        .nav-btn.active { color: var(--green); border-bottom-color: var(--green); background: rgba(16,185,129,0.1); }
        
        .main { max-width: 1400px; margin: 0 auto; padding: 0.9rem; }
        .page { display: none; animation: fadeIn 0.2s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .grid-kpi { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 0.9rem; }
        @media (max-width: 600px) { .grid-kpi { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 400px) { .grid-kpi { grid-template-columns: repeat(2, 1fr); } }
        .kpi { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 0.6rem; position: relative; overflow: hidden; }
        .kpi::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
        .kpi.green::before { background: var(--green); }
        .kpi.blue::before { background: var(--blue); }
        .kpi.yellow::before { background: var(--yellow); }
        .kpi.purple::before { background: var(--purple); }
        .kpi.red::before { background: var(--red); }
        .kpi-label { color: var(--text2); font-size: 0.55rem; margin-bottom: 0.15rem; text-transform: uppercase; }
        .kpi-value { font-family: 'Space Mono', monospace; font-size: 0.9rem; font-weight: 700; }
        .kpi.green .kpi-value { color: var(--green); }
        .kpi.blue .kpi-value { color: var(--blue); }
        .kpi.yellow .kpi-value { color: var(--yellow); }
        .kpi.purple .kpi-value { color: var(--purple); }
        .kpi.red .kpi-value { color: var(--red); }
        
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem; }
        .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem; flex-wrap: wrap; gap: 0.4rem; }
        .card-title { font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 0.3rem; }
        
        .tbl-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid var(--border); border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.68rem; }
        th { background: var(--bg-secondary); color: var(--text2); font-weight: 600; text-align: left; padding: 0.45rem 0.35rem; border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 0.4rem 0.35rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover td { background: var(--bg-hover); }
        tr:last-child td { border-bottom: none; }
        
        .badge { display: inline-block; padding: 0.1rem 0.35rem; border-radius: 4px; font-size: 0.55rem; font-weight: 600; }
        .badge.green { background: rgba(16,185,129,0.2); color: var(--green); }
        .badge.yellow { background: rgba(245,158,11,0.2); color: var(--yellow); }
        .badge.red { background: rgba(239,68,68,0.2); color: var(--red); }
        .badge.blue { background: rgba(59,130,246,0.2); color: var(--blue); }
        .badge.purple { background: rgba(139,92,246,0.2); color: var(--purple); }
        .badge.cyan { background: rgba(6,182,212,0.2); color: var(--cyan); }
        .badge.orange { background: rgba(249,115,22,0.2); color: var(--orange); }
        .badge.pink { background: rgba(236,72,153,0.2); color: var(--pink); }
        
        .mono { font-family: 'Space Mono', monospace; }
        
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.4rem; }
        .field { margin-bottom: 0.4rem; }
        .field label { display: block; color: var(--text2); font-size: 0.6rem; margin-bottom: 0.1rem; font-weight: 500; }
        .field input, .field select { width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; padding: 0.45rem; color: var(--text); font-family: inherit; font-size: 0.75rem; }
        .field input:focus, .field select:focus { outline: none; border-color: var(--green); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.25rem; padding: 0.5rem 0.9rem; border: none; border-radius: 6px; font-family: inherit; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.15s; min-height: 36px; touch-action: manipulation; }
        .btn-p { background: linear-gradient(135deg, var(--green), var(--blue)); color: white; }
        .btn-p:hover, .btn-p:active { opacity: 0.9; }
        .btn-d { background: rgba(239,68,68,0.15); color: var(--red); }
        .btn-e { background: rgba(59,130,246,0.15); color: var(--blue); }
        .btn-s { background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border); }
        .btn-sm { padding: 0.35rem 0.45rem; font-size: 0.6rem; min-height: 30px; min-width: 30px; }
        .actions { display: flex; gap: 0.2rem; justify-content: flex-end; }
        
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: flex-end; justify-content: center; }
        .modal-bg.show { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px 16px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: 1rem; animation: slideUp 0.2s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
        .modal-head h3 { font-size: 0.85rem; }
        .modal-close { background: var(--bg-secondary); border: none; color: var(--text); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; }
        .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 0.8rem; }
        @media (min-width: 600px) { .modal-bg { align-items: center; padding: 1rem; } .modal { border-radius: 12px; } .modal-handle { display: none; } }
        
        .upload-box { border: 2px dashed var(--border); border-radius: 10px; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .upload-box:hover, .upload-box.dragover { border-color: var(--green); background: rgba(16,185,129,0.05); }
        .upload-box.has-file { border-color: var(--green); border-style: solid; }
        .upload-icon { font-size: 1.5rem; margin-bottom: 0.2rem; }
        .upload-text { font-size: 0.7rem; color: var(--text2); }
        .upload-file { font-size: 0.65rem; color: var(--green); margin-top: 0.2rem; font-weight: 600; }
        
        .alert { padding: 0.45rem 0.6rem; border-radius: 6px; font-size: 0.65rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.3rem; }
        .alert.info { background: rgba(59,130,246,0.15); color: var(--blue); }
        .alert.warn { background: rgba(245,158,11,0.15); color: var(--yellow); }
        .alert.ok { background: rgba(16,185,129,0.15); color: var(--green); }
        
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .toast { background: var(--bg-card); border: 1px solid var(--green); padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.7rem; display: flex; align-items: center; gap: 0.4rem; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .toast.error { border-color: var(--red); }
        
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .ing-list { border: 1px solid var(--border); border-radius: 6px; max-height: 150px; overflow-y: auto; }
        .ing-item { display: flex; justify-content: space-between; align-items: center; padding: 0.35rem 0.45rem; border-bottom: 1px solid var(--border); font-size: 0.65rem; }
        .ing-item:last-child { border-bottom: none; }
        
        .res-box { background: var(--bg-secondary); border-radius: 6px; padding: 0.5rem; display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.3rem; margin-top: 0.5rem; }
        @media (max-width: 400px) { .res-box { grid-template-columns: repeat(3, 1fr); } }
        .res-item { text-align: center; }
        .res-item .lbl { font-size: 0.45rem; color: var(--text3); text-transform: uppercase; }
        .res-item .val { font-family: 'Space Mono', monospace; font-size: 0.7rem; font-weight: 700; }
        
        .empty { text-align: center; padding: 1rem; color: var(--text3); font-size: 0.7rem; }
        .empty-icon { font-size: 1.3rem; margin-bottom: 0.3rem; opacity: 0.5; }
        
        .chart-box { height: 170px; }
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 0.8rem; }
        @media (min-width: 650px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .preview { background: var(--bg-secondary); border-radius: 6px; padding: 0.6rem; margin-top: 0.6rem; }
        .prev-group { background: var(--bg-card); border-radius: 4px; padding: 0.4rem; margin-bottom: 0.3rem; display: flex; justify-content: space-between; font-size: 0.65rem; }
        
        .cardapio-tag { display: inline-flex; align-items: center; gap: 0.2rem; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.55rem; font-weight: 600; }
        .cardapio-tag.ifood { background: rgba(234,67,53,0.2); color: #ea4335; }
        .cardapio-tag.anotaai { background: rgba(52,168,83,0.2); color: #34a853; }
        
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        @media (max-width: 500px) { .compare-grid { grid-template-columns: 1fr; } }
        .compare-col { background: var(--bg-secondary); border-radius: 6px; padding: 0.5rem; }
        .compare-header { font-weight: 600; font-size: 0.75rem; margin-bottom: 0.4rem; text-align: center; padding-bottom: 0.3rem; border-bottom: 1px solid var(--border); }
        .compare-item { display: flex; justify-content: space-between; font-size: 0.65rem; padding: 0.2rem 0; }
        .compare-diff { font-size: 0.55rem; margin-left: 0.2rem; }
        .compare-diff.up { color: var(--green); }
        .compare-diff.down { color: var(--red); }

        ::-webkit-scrollbar { width: 3px; height: 3px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        
        .section-title { font-size: 0.7rem; color: var(--text2); margin: 0.6rem 0 0.3rem; font-weight: 600; border-bottom: 1px solid var(--border); padding-bottom: 0.2rem; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üçù</div>
                <div><h1>CMV Control</h1><span>Ital'in House</span></div>
            </div>
            <div class="header-right">
                <div class="sync-status online" id="sync-status">‚òÅÔ∏è Online</div>
                <div class="header-date" id="dataAtual"></div>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="nav-content">
            <button class="nav-btn active" data-p="dashboard">üìä Dash</button>
            <button class="nav-btn" data-p="ingredientes">üßÖ Ingred.</button>
            <button class="nav-btn" data-p="massas">üçù Massas</button>
            <button class="nav-btn" data-p="extras">‚ûï Extras</button>
            <button class="nav-btn" data-p="bebidas">ü•§ Bebidas</button>
            <button class="nav-btn" data-p="produtos">üçΩÔ∏è Produtos</button>
            <button class="nav-btn" data-p="combos">üéØ Combos</button>
            <button class="nav-btn" data-p="fichas">üìã Fichas</button>
            <button class="nav-btn" data-p="importar">üì• Import</button>
            <button class="nav-btn" data-p="analise">üìà An√°lise</button>
            <button class="nav-btn" data-p="comparar">‚öñÔ∏è Comparar</button>
            <button class="nav-btn" data-p="config">‚öôÔ∏è Config</button>
        </div>
    </nav>

    <main class="main">
        <!-- DASHBOARD -->
        <div class="page active" id="p-dashboard">
            <div class="grid-kpi">
                <div class="kpi green"><div class="kpi-label">Faturamento</div><div class="kpi-value" id="k-fat">R$ 0</div></div>
                <div class="kpi blue"><div class="kpi-label">Custo</div><div class="kpi-value" id="k-custo">R$ 0</div></div>
                <div class="kpi yellow"><div class="kpi-label">CMV</div><div class="kpi-value" id="k-cmv">0%</div></div>
                <div class="kpi purple"><div class="kpi-label">Lucro</div><div class="kpi-value" id="k-lucro">R$ 0</div></div>
                <div class="kpi red"><div class="kpi-label">Itens</div><div class="kpi-value" id="k-itens">0</div></div>
            </div>
            <div class="chart-grid">
                <div class="card"><div class="card-title">üìä Por Grupo</div><div class="chart-box"><canvas id="chart1"></canvas></div></div>
                <div class="card"><div class="card-title">üìà CMV por M√™s</div><div class="chart-box"><canvas id="chart2"></canvas></div></div>
            </div>
            <div class="card">
                <div class="card-title">üìã Vendas por Grupo</div>
                <div class="tbl-wrap" style="margin-top:0.4rem;"><table><thead><tr><th>Grupo</th><th>Qtd</th><th>Fat.</th><th>%</th></tr></thead><tbody id="tbl-dash"></tbody></table></div>
            </div>
        </div>

        <!-- INGREDIENTES -->
        <div class="page" id="p-ingredientes">
            <div class="card">
                <div class="card-head"><span class="card-title">üßÖ Ingredientes</span><button class="btn btn-p" onclick="abrirModal('mod-ing')">+ Novo</button></div>
                <div class="tbl-wrap"><table><thead><tr><th>Nome</th><th>Un</th><th>Custo</th><th>Forn.</th><th></th></tr></thead><tbody id="tbl-ing"></tbody></table></div>
            </div>
        </div>

        <!-- MASSAS -->
        <div class="page" id="p-massas">
            <div class="card">
                <div class="card-head"><span class="card-title">üçù Massas</span><button class="btn btn-p" onclick="abrirModal('mod-massa')">+ Nova</button></div>
                <div class="alert info">üí° Custo da massa por tamanho (Box P 450g / Box G 800g)</div>
                <div class="tbl-wrap"><table><thead><tr><th>Tipo</th><th>Custo P</th><th>Custo G</th><th></th></tr></thead><tbody id="tbl-massa"></tbody></table></div>
            </div>
        </div>

        <!-- EXTRAS -->
        <div class="page" id="p-extras">
            <div class="card">
                <div class="card-head"><span class="card-title">‚ûï Extras</span><button class="btn btn-p" onclick="abrirModal('mod-extra')">+ Novo</button></div>
                <div class="tbl-wrap"><table><thead><tr><th>Nome</th><th>Pre√ßo</th><th>Custo</th><th>CMV</th><th></th></tr></thead><tbody id="tbl-extra"></tbody></table></div>
            </div>
        </div>

        <!-- BEBIDAS -->
        <div class="page" id="p-bebidas">
            <div class="card">
                <div class="card-head"><span class="card-title">ü•§ Bebidas</span><button class="btn btn-p" onclick="abrirModal('mod-bebida')">+ Nova</button></div>
                <div class="tbl-wrap"><table><thead><tr><th>Nome</th><th>Pre√ßo</th><th>Custo</th><th>CMV</th><th></th></tr></thead><tbody id="tbl-bebida"></tbody></table></div>
            </div>
        </div>

        <!-- PRODUTOS -->
        <div class="page" id="p-produtos">
            <div class="card">
                <div class="card-head"><span class="card-title">üçΩÔ∏è Produtos</span><button class="btn btn-p" onclick="abrirModal('mod-prod')">+ Novo</button></div>
                <div class="alert info">üí° Pre√ßos por card√°pio: <span class="cardapio-tag ifood">iFood</span> <span class="cardapio-tag anotaai">AnotaAi</span></div>
                <div class="tbl-wrap"><table><thead><tr><th>Nome</th><th>Cat</th><th>iFood P</th><th>iFood G</th><th>Anota P</th><th>Anota G</th><th></th></tr></thead><tbody id="tbl-prod"></tbody></table></div>
            </div>
        </div>

        <!-- COMBOS -->
        <div class="page" id="p-combos">
            <div class="card">
                <div class="card-head"><span class="card-title">üéØ Combos</span><button class="btn btn-p" onclick="abrirModal('mod-combo')">+ Novo</button></div>
                <div class="alert info">üí° Itens dos combos s√£o redistribu√≠dos na an√°lise de CMV</div>
                <div class="tbl-wrap"><table><thead><tr><th>Nome</th><th>Comp.</th><th>iFood</th><th>AnotaAi</th><th></th></tr></thead><tbody id="tbl-combo"></tbody></table></div>
            </div>
        </div>

        <!-- FICHAS -->
        <div class="page" id="p-fichas">
            <div class="card">
                <div class="card-title" style="margin-bottom:0.5rem;">üìã Fichas T√©cnicas</div>
                <div class="form-row">
                    <div class="field"><label>Produto</label><select id="ficha-prod" onchange="carregarFicha()"></select></div>
                    <div class="field"><label>Tamanho</label><select id="ficha-tam" onchange="carregarFicha()"><option value="P">Box P (450g)</option><option value="G">Box G (800g)</option></select></div>
                </div>
                <div id="ficha-area" style="display:none;">
                    <div style="background:var(--bg-secondary);border-radius:6px;padding:0.5rem;margin-top:0.4rem;">
                        <div style="font-size:0.65rem;font-weight:600;margin-bottom:0.3rem;">üßÖ Ingredientes</div>
                        <div style="display:flex;gap:0.3rem;flex-wrap:wrap;margin-bottom:0.3rem;">
                            <select id="ficha-ing" style="flex:1;min-width:80px;background:var(--bg-card);border:1px solid var(--border);border-radius:4px;padding:0.35rem;color:var(--text);font-size:0.65rem;"></select>
                            <input type="number" id="ficha-qtd" placeholder="Qtd" step="0.001" style="width:55px;background:var(--bg-card);border:1px solid var(--border);border-radius:4px;padding:0.35rem;color:var(--text);font-size:0.65rem;">
                            <button class="btn btn-p btn-sm" onclick="addIngFicha()">+</button>
                        </div>
                        <div class="ing-list" id="ficha-list"></div>
                    </div>
                    <div class="res-box">
                        <div class="res-item"><div class="lbl">Ingred.</div><div class="val" style="color:var(--yellow);" id="f-cing">R$0</div></div>
                        <div class="res-item"><div class="lbl">Massa</div><div class="val" style="color:var(--blue);" id="f-cmassa">R$0</div></div>
                        <div class="res-item"><div class="lbl">Total</div><div class="val" style="color:var(--green);" id="f-ctotal">R$0</div></div>
                        <div class="res-item"><div class="lbl">Pre√ßo iF</div><div class="val" style="color:var(--red);" id="f-preco-if">R$0</div></div>
                        <div class="res-item"><div class="lbl">Pre√ßo An</div><div class="val" style="color:var(--purple);" id="f-preco-an">R$0</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- IMPORTAR -->
        <div class="page" id="p-importar">
            <div class="card">
                <div class="card-title" style="margin-bottom:0.5rem;">üì• Importar Vendas</div>
                <div class="upload-box" id="upload-box">
                    <div class="upload-icon">üìÅ</div>
                    <p class="upload-text">Toque para selecionar</p>
                    <p class="upload-file" id="upload-file"></p>
                    <input type="file" id="file-input" accept=".xlsx,.xls" style="display:none">
                </div>
                <div id="import-preview"></div>
            </div>
            <div class="card">
                <div class="card-head"><span class="card-title">üìÖ Importa√ß√µes</span></div>
                <div class="tbl-wrap"><table><thead><tr><th>Per√≠odo</th><th>Card.</th><th>Fat.</th><th>CMV</th><th></th></tr></thead><tbody id="tbl-meses"></tbody></table></div>
            </div>
        </div>

        <!-- AN√ÅLISE -->
        <div class="page" id="p-analise">
            <div class="card">
                <div class="card-head">
                    <span class="card-title">üìà An√°lise</span>
                    <select id="sel-mes" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;padding:0.35rem;color:var(--text);font-size:0.65rem;"></select>
                </div>
            </div>
            <div id="analise-area"></div>
        </div>

        <!-- COMPARAR -->
        <div class="page" id="p-comparar">
            <div class="card">
                <div class="card-title" style="margin-bottom:0.5rem;">‚öñÔ∏è Comparar</div>
                <div class="form-row">
                    <div class="field"><label>Per√≠odo 1</label><select id="comp-mes1"></select></div>
                    <div class="field"><label>Per√≠odo 2</label><select id="comp-mes2"></select></div>
                    <div class="field" style="display:flex;align-items:flex-end;"><button class="btn btn-p" onclick="compararMeses()">Comparar</button></div>
                </div>
            </div>
            <div id="compare-area"></div>
        </div>

        <!-- CONFIG -->
        <div class="page" id="p-config">
            <div class="card">
                <div class="card-title" style="margin-bottom:0.5rem;">‚öôÔ∏è Configura√ß√µes</div>
                <div class="alert info">‚òÅÔ∏è Dados salvos no servidor (Neon PostgreSQL)</div>
                <div style="margin-top:0.5rem;display:flex;gap:0.5rem;flex-wrap:wrap;">
                    <button class="btn btn-s" onclick="setupDB()">üîß Setup DB</button>
                    <button class="btn btn-s" onclick="seedDB()">üå± Dados Iniciais</button>
                    <button class="btn btn-d" onclick="limparDados()">üóëÔ∏è Resetar Tudo</button>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <div class="modal-bg" id="mod-ing"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><h3>Ingrediente</h3><button class="modal-close" onclick="fecharModal('mod-ing')">√ó</button></div>
        <form id="form-ing"><input type="hidden" id="ing-id">
            <div class="form-row"><div class="field"><label>Nome *</label><input type="text" id="ing-nome" required></div><div class="field"><label>Unidade *</label><select id="ing-un" required><option value="kg">kg</option><option value="g">g</option><option value="L">L</option><option value="ml">ml</option><option value="un">un</option></select></div></div>
            <div class="form-row"><div class="field"><label>Custo/Un (R$) *</label><input type="number" id="ing-custo" step="0.01" min="0"></div><div class="field"><label>Fornecedor</label><input type="text" id="ing-forn"></div></div>
            <button type="submit" class="btn btn-p" style="width:100%;">üíæ Salvar</button>
        </form>
    </div></div>

    <div class="modal-bg" id="mod-massa"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><h3>Massa</h3><button class="modal-close" onclick="fecharModal('mod-massa')">√ó</button></div>
        <form id="form-massa"><input type="hidden" id="massa-id">
            <div class="field"><label>Tipo *</label><input type="text" id="massa-nome" required></div>
            <div class="form-row"><div class="field"><label>Custo Box P (R$) *</label><input type="number" id="massa-cp" step="0.01" min="0"></div><div class="field"><label>Custo Box G (R$) *</label><input type="number" id="massa-cg" step="0.01" min="0"></div></div>
            <button type="submit" class="btn btn-p" style="width:100%;">üíæ Salvar</button>
        </form>
    </div></div>

    <div class="modal-bg" id="mod-extra"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><h3>Extra</h3><button class="modal-close" onclick="fecharModal('mod-extra')">√ó</button></div>
        <form id="form-extra"><input type="hidden" id="extra-id">
            <div class="field"><label>Nome *</label><input type="text" id="extra-nome" required></div>
            <div class="form-row"><div class="field"><label>Pre√ßo Venda (R$)</label><input type="number" id="extra-preco" step="0.01" min="0"></div><div class="field"><label>Custo (R$)</label><input type="number" id="extra-custo" step="0.01" min="0"></div></div>
            <button type="submit" class="btn btn-p" style="width:100%;">üíæ Salvar</button>
        </form>
    </div></div>

    <div class="modal-bg" id="mod-bebida"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><h3>Bebida</h3><button class="modal-close" onclick="fecharModal('mod-bebida')">√ó</button></div>
        <form id="form-bebida"><input type="hidden" id="bebida-id">
            <div class="field"><label>Nome *</label><input type="text" id="bebida-nome" required></div>
            <div class="form-row"><div class="field"><label>Pre√ßo Venda (R$)</label><input type="number" id="bebida-preco" step="0.01" min="0"></div><div class="field"><label>Custo (R$)</label><input type="number" id="bebida-custo" step="0.01" min="0"></div></div>
            <button type="submit" class="btn btn-p" style="width:100%;">üíæ Salvar</button>
        </form>
    </div></div>

    <div class="modal-bg" id="mod-prod"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><h3>Produto</h3><button class="modal-close" onclick="fecharModal('mod-prod')">√ó</button></div>
        <form id="form-prod"><input type="hidden" id="prod-id">
            <div class="form-row"><div class="field"><label>Nome *</label><input type="text" id="prod-nome" required></div><div class="field"><label>Categoria *</label><select id="prod-cat" required><option value="macarrao">Macarr√£o</option><option value="risoto">Risoto</option><option value="nhoque">Nhoque</option><option value="salada">Salada</option><option value="sobremesa">Sobremesa</option><option value="outros">Outros</option></select></div></div>
            <div class="section-title">üì± Pre√ßos iFood</div>
            <div class="form-row"><div class="field"><label>Box P (R$)</label><input type="number" id="prod-if-p" step="0.01" min="0"></div><div class="field"><label>Box G (R$)</label><input type="number" id="prod-if-g" step="0.01" min="0"></div></div>
            <div class="section-title">üì≤ Pre√ßos AnotaAi</div>
            <div class="form-row"><div class="field"><label>Box P (R$)</label><input type="number" id="prod-an-p" step="0.01" min="0"></div><div class="field"><label>Box G (R$)</label><input type="number" id="prod-an-g" step="0.01" min="0"></div></div>
            <button type="submit" class="btn btn-p" style="width:100%;margin-top:0.5rem;">üíæ Salvar</button>
        </form>
    </div></div>

    <div class="modal-bg" id="mod-combo"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><h3>Combo</h3><button class="modal-close" onclick="fecharModal('mod-combo')">√ó</button></div>
        <form id="form-combo"><input type="hidden" id="combo-id">
            <div class="field"><label>Nome *</label><input type="text" id="combo-nome" required></div>
            <div class="section-title">üí∞ Pre√ßos</div>
            <div class="form-row"><div class="field"><label>iFood (R$)</label><input type="number" id="combo-preco-if" step="0.01" min="0"></div><div class="field"><label>AnotaAi (R$)</label><input type="number" id="combo-preco-an" step="0.01" min="0"></div></div>
            <div class="section-title">üì¶ Composi√ß√£o</div>
            <div class="form-row"><div class="field"><label>Qtd Box P</label><input type="number" id="combo-qp" value="0" min="0"></div><div class="field"><label>Qtd Box G</label><input type="number" id="combo-qg" value="0" min="0"></div></div>
            <div class="form-row"><div class="field"><label>Bebida</label><select id="combo-bebida"><option value="">Nenhuma</option></select></div><div class="field"><label>Brinde</label><select id="combo-brinde"><option value="">Nenhum</option></select></div></div>
            <button type="submit" class="btn btn-p" style="width:100%;margin-top:0.5rem;">üíæ Salvar</button>
        </form>
    </div></div>

<script>
// ==================== API HELPERS ====================
const API = '/api';

async function api(endpoint, method = 'GET', body = null) {
    try {
        const opts = { method, headers: { 'Content-Type': 'application/json' } };
        if (body) opts.body = JSON.stringify(body);
        const res = await fetch(API + '/' + endpoint, opts);
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
    } catch (e) {
        console.error('API Error:', e);
        setSyncStatus(false);
        throw e;
    }
}

function setSyncStatus(online) {
    const el = $('sync-status');
    if (online) {
        el.className = 'sync-status online';
        el.innerHTML = '‚òÅÔ∏è Online';
    } else {
        el.className = 'sync-status offline';
        el.innerHTML = '‚ö†Ô∏è Offline';
    }
}

// ==================== DATABASE ====================
const DB = { ingredientes: [], massas: [], extras: [], bebidas: [], brindes: [], produtos: [], combos: [], fichas: [], vendas: [] };

let importData = null, chart1 = null, chart2 = null;

// ==================== UTILS ====================
const $ = id => document.getElementById(id);
const R$ = v => 'R$ ' + (parseFloat(v)||0).toFixed(2).replace('.',',');
const toast = (msg, err) => { $('toast-container').innerHTML = `<div class="toast ${err?'error':''}">${err?'‚ùå':'‚úÖ'} ${msg}</div>`; setTimeout(() => $('toast-container').innerHTML = '', 2500); };
const showLoading = show => { let el = $('loading-overlay'); if(show && !el) { el = document.createElement('div'); el.id = 'loading-overlay'; el.className = 'loading-overlay'; el.innerHTML = '<div class="spinner"></div><div style="color:var(--text2);font-size:0.75rem;">Carregando...</div>'; document.body.appendChild(el); } else if(!show && el) el.remove(); };

function abrirModal(id, editId) {
    if(editId) preencherForm(id, editId);
    $(id).classList.add('show');
    if(id === 'mod-combo') atualizarSelectsCombo();
    document.body.style.overflow = 'hidden';
}

function fecharModal(id) {
    $(id).classList.remove('show');
    document.body.style.overflow = '';
    const form = $(id).querySelector('form');
    if(form) form.reset();
}

function preencherForm(mid, id) {
    const m = { 
        'mod-ing': () => { const i = DB.ingredientes.find(x=>x.id===id); if(i){ $('ing-id').value=id; $('ing-nome').value=i.nome; $('ing-un').value=i.un; $('ing-custo').value=i.custo; $('ing-forn').value=i.forn||''; }},
        'mod-massa': () => { const i = DB.massas.find(x=>x.id===id); if(i){ $('massa-id').value=id; $('massa-nome').value=i.nome; $('massa-cp').value=i.custo_p; $('massa-cg').value=i.custo_g; }},
        'mod-extra': () => { const i = DB.extras.find(x=>x.id===id); if(i){ $('extra-id').value=id; $('extra-nome').value=i.nome; $('extra-preco').value=i.preco; $('extra-custo').value=i.custo; }},
        'mod-bebida': () => { const i = DB.bebidas.find(x=>x.id===id); if(i){ $('bebida-id').value=id; $('bebida-nome').value=i.nome; $('bebida-preco').value=i.preco; $('bebida-custo').value=i.custo; }},
        'mod-prod': () => { const i = DB.produtos.find(x=>x.id===id); if(i){ $('prod-id').value=id; $('prod-nome').value=i.nome; $('prod-cat').value=i.cat; $('prod-if-p').value=i.ifood_p||''; $('prod-if-g').value=i.ifood_g||''; $('prod-an-p').value=i.anota_p||''; $('prod-an-g').value=i.anota_g||''; }},
        'mod-combo': () => { const i = DB.combos.find(x=>x.id===id); if(i){ $('combo-id').value=id; $('combo-nome').value=i.nome; $('combo-preco-if').value=i.preco_ifood; $('combo-preco-an').value=i.preco_anota; $('combo-qp').value=i.qp||0; $('combo-qg').value=i.qg||0; setTimeout(()=>{ $('combo-bebida').value=i.bebida_id||''; $('combo-brinde').value=i.brinde_id||''; },50); }}
    }; 
    if(m[mid]) m[mid]();
}

// ==================== LOAD DATA ====================
async function loadAll() {
    showLoading(true);
    try {
        DB.ingredientes = await api('ingredientes');
        DB.massas = await api('massas');
        DB.extras = await api('extras');
        DB.bebidas = await api('bebidas');
        DB.brindes = await api('brindes');
        DB.produtos = await api('produtos');
        DB.combos = await api('combos');
        DB.fichas = await api('fichas');
        DB.vendas = await api('vendas');
        setSyncStatus(true);
        renderAll();
    } catch (e) {
        toast('Erro ao carregar dados!', true);
    }
    showLoading(false);
}

// ==================== NAVIGATION ====================
document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        $('p-' + btn.dataset.p).classList.add('active');
    };
});

// ==================== RENDERS ====================
function renderIng() { $('tbl-ing').innerHTML = DB.ingredientes.length === 0 ? '<tr><td colspan="5"><div class="empty"><div class="empty-icon">üßÖ</div>Nenhum</div></td></tr>' : DB.ingredientes.map(i => `<tr><td><b>${i.nome}</b></td><td>${i.un}</td><td class="mono">${R$(i.custo)}</td><td>${i.forn||'-'}</td><td class="actions"><button class="btn btn-e btn-sm" onclick="abrirModal('mod-ing',${i.id})">‚úèÔ∏è</button><button class="btn btn-d btn-sm" onclick="delIng(${i.id})">üóëÔ∏è</button></td></tr>`).join(''); }
function renderMassa() { $('tbl-massa').innerHTML = DB.massas.map(m => `<tr><td><b>${m.nome}</b></td><td class="mono">${R$(m.custo_p)}</td><td class="mono">${R$(m.custo_g)}</td><td class="actions"><button class="btn btn-e btn-sm" onclick="abrirModal('mod-massa',${m.id})">‚úèÔ∏è</button><button class="btn btn-d btn-sm" onclick="delMassa(${m.id})">üóëÔ∏è</button></td></tr>`).join(''); }
function renderExtra() { $('tbl-extra').innerHTML = DB.extras.map(e => { const cmv = e.preco > 0 ? ((e.custo/e.preco)*100).toFixed(0) : '0'; return `<tr><td><b>${e.nome}</b></td><td class="mono">${R$(e.preco)}</td><td class="mono">${R$(e.custo)}</td><td><span class="badge ${cmv<=30?'green':cmv<=40?'yellow':'red'}">${cmv}%</span></td><td class="actions"><button class="btn btn-e btn-sm" onclick="abrirModal('mod-extra',${e.id})">‚úèÔ∏è</button><button class="btn btn-d btn-sm" onclick="delExtra(${e.id})">üóëÔ∏è</button></td></tr>`; }).join(''); }
function renderBebida() { $('tbl-bebida').innerHTML = DB.bebidas.map(b => { const cmv = b.preco > 0 ? ((b.custo/b.preco)*100).toFixed(0) : '0'; return `<tr><td><b>${b.nome}</b></td><td class="mono">${R$(b.preco)}</td><td class="mono">${R$(b.custo)}</td><td><span class="badge ${cmv<=40?'green':cmv<=50?'yellow':'red'}">${cmv}%</span></td><td class="actions"><button class="btn btn-e btn-sm" onclick="abrirModal('mod-bebida',${b.id})">‚úèÔ∏è</button><button class="btn btn-d btn-sm" onclick="delBebida(${b.id})">üóëÔ∏è</button></td></tr>`; }).join(''); }
function renderProd() { $('tbl-prod').innerHTML = DB.produtos.map(p => `<tr><td><b>${p.nome}</b></td><td><span class="badge ${p.cat==='macarrao'?'blue':p.cat==='risoto'?'orange':p.cat==='nhoque'?'pink':'cyan'}">${p.cat.slice(0,3)}</span></td><td class="mono">${p.ifood_p>0?R$(p.ifood_p):'-'}</td><td class="mono">${p.ifood_g>0?R$(p.ifood_g):'-'}</td><td class="mono">${p.anota_p>0?R$(p.anota_p):'-'}</td><td class="mono">${p.anota_g>0?R$(p.anota_g):'-'}</td><td class="actions"><button class="btn btn-e btn-sm" onclick="abrirModal('mod-prod',${p.id})">‚úèÔ∏è</button><button class="btn btn-d btn-sm" onclick="delProd(${p.id})">üóëÔ∏è</button></td></tr>`).join(''); }
function renderCombo() { $('tbl-combo').innerHTML = DB.combos.map(c => { let comp = []; if(c.qp>0) comp.push(`${c.qp}xP`); if(c.qg>0) comp.push(`${c.qg}xG`); if(c.bebida_id) comp.push('ü•§'); if(c.brinde_id) comp.push('üéÅ'); return `<tr><td><b>${c.nome}</b></td><td style="font-size:0.55rem;">${comp.join('+')}</td><td class="mono">${R$(c.preco_ifood)}</td><td class="mono">${R$(c.preco_anota)}</td><td class="actions"><button class="btn btn-e btn-sm" onclick="abrirModal('mod-combo',${c.id})">‚úèÔ∏è</button><button class="btn btn-d btn-sm" onclick="delCombo(${c.id})">üóëÔ∏è</button></td></tr>`; }).join(''); }
function renderMeses() { 
    $('tbl-meses').innerHTML = DB.vendas.length === 0 ? '<tr><td colspan="5"><div class="empty"><div class="empty-icon">üìÖ</div>Nenhum</div></td></tr>' : DB.vendas.map(v => { 
        const cmv = v.total_fat > 0 ? ((v.total_custo/v.total_fat)*100).toFixed(0) : '0'; 
        return `<tr><td><b>${v.mes}/${v.ano}</b></td><td><span class="cardapio-tag ${v.cardapio}">${v.cardapio==='ifood'?'iFood':'AnotaAi'}</span></td><td class="mono">${R$(v.total_fat)}</td><td><span class="badge ${cmv<=30?'green':cmv<=40?'yellow':'red'}">${cmv}%</span></td><td class="actions"><button class="btn btn-d btn-sm" onclick="delMes(${v.id})">üóëÔ∏è</button></td></tr>`; 
    }).join(''); 
    atualizarSelectsMeses(); 
}

function atualizarSelectsMeses() {
    const opts = '<option value="">Selecione</option>' + DB.vendas.map(v => `<option value="${v.id}">${v.mes}/${v.ano} - ${v.cardapio==='ifood'?'iFood':'AnotaAi'}</option>`).join('');
    $('sel-mes').innerHTML = opts;
    $('comp-mes1').innerHTML = opts;
    $('comp-mes2').innerHTML = opts;
}

// ==================== DELETES ====================
async function delIng(id) { if(confirm('Excluir?')) { await api('ingredientes', 'DELETE', {id}); DB.ingredientes = DB.ingredientes.filter(i=>i.id!==id); renderIng(); atualizarFichaSelects(); toast('Exclu√≠do'); }}
async function delMassa(id) { if(confirm('Excluir?')) { await api('massas', 'DELETE', {id}); DB.massas = DB.massas.filter(m=>m.id!==id); renderMassa(); toast('Exclu√≠do'); }}
async function delExtra(id) { if(confirm('Excluir?')) { await api('extras', 'DELETE', {id}); DB.extras = DB.extras.filter(e=>e.id!==id); renderExtra(); toast('Exclu√≠do'); }}
async function delBebida(id) { if(confirm('Excluir?')) { await api('bebidas', 'DELETE', {id}); DB.bebidas = DB.bebidas.filter(b=>b.id!==id); renderBebida(); toast('Exclu√≠do'); }}
async function delProd(id) { if(confirm('Excluir?')) { await api('produtos', 'DELETE', {id}); DB.produtos = DB.produtos.filter(p=>p.id!==id); renderProd(); atualizarFichaSelects(); toast('Exclu√≠do'); }}
async function delCombo(id) { if(confirm('Excluir?')) { await api('combos', 'DELETE', {id}); DB.combos = DB.combos.filter(c=>c.id!==id); renderCombo(); toast('Exclu√≠do'); }}
async function delMes(id) { if(confirm('Excluir?')) { await api('vendas', 'DELETE', {id}); DB.vendas = DB.vendas.filter(v=>v.id!==id); renderMeses(); atualizarDash(); toast('Exclu√≠do'); }}

// ==================== FORMS ====================
$('form-ing').onsubmit = async function(e) { 
    e.preventDefault(); 
    const nome = $('ing-nome').value.trim();
    if(!nome) { toast('Preencha o nome!', true); return; }
    const id = parseInt($('ing-id').value);
    const d = {nome, un: $('ing-un').value, custo: parseFloat($('ing-custo').value)||0, forn: $('ing-forn').value.trim()}; 
    try {
        if(id) { const r = await api('ingredientes', 'PUT', {...d, id}); const i = DB.ingredientes.findIndex(x=>x.id===id); if(i>=0) DB.ingredientes[i] = r; } 
        else { const r = await api('ingredientes', 'POST', d); DB.ingredientes.push(r); }
        renderIng(); atualizarFichaSelects(); fecharModal('mod-ing'); toast('Salvo!');
    } catch(e) { toast('Erro ao salvar!', true); }
};

$('form-massa').onsubmit = async function(e) { 
    e.preventDefault(); 
    const nome = $('massa-nome').value.trim();
    if(!nome) { toast('Preencha o nome!', true); return; }
    const id = parseInt($('massa-id').value);
    const d = {nome, custo_p: parseFloat($('massa-cp').value)||0, custo_g: parseFloat($('massa-cg').value)||0}; 
    try {
        if(id) { const r = await api('massas', 'PUT', {...d, id}); const i = DB.massas.findIndex(x=>x.id===id); if(i>=0) DB.massas[i] = r; } 
        else { const r = await api('massas', 'POST', d); DB.massas.push(r); }
        renderMassa(); fecharModal('mod-massa'); toast('Salvo!');
    } catch(e) { toast('Erro ao salvar!', true); }
};

$('form-extra').onsubmit = async function(e) { 
    e.preventDefault(); 
    const nome = $('extra-nome').value.trim();
    if(!nome) { toast('Preencha o nome!', true); return; }
    const id = parseInt($('extra-id').value);
    const d = {nome, preco: parseFloat($('extra-preco').value)||0, custo: parseFloat($('extra-custo').value)||0}; 
    try {
        if(id) { const r = await api('extras', 'PUT', {...d, id}); const i = DB.extras.findIndex(x=>x.id===id); if(i>=0) DB.extras[i] = r; } 
        else { const r = await api('extras', 'POST', d); DB.extras.push(r); }
        renderExtra(); fecharModal('mod-extra'); toast('Salvo!');
    } catch(e) { toast('Erro ao salvar!', true); }
};

$('form-bebida').onsubmit = async function(e) { 
    e.preventDefault(); 
    const nome = $('bebida-nome').value.trim();
    if(!nome) { toast('Preencha o nome!', true); return; }
    const id = parseInt($('bebida-id').value);
    const d = {nome, preco: parseFloat($('bebida-preco').value)||0, custo: parseFloat($('bebida-custo').value)||0}; 
    try {
        if(id) { const r = await api('bebidas', 'PUT', {...d, id}); const i = DB.bebidas.findIndex(x=>x.id===id); if(i>=0) DB.bebidas[i] = r; } 
        else { const r = await api('bebidas', 'POST', d); DB.bebidas.push(r); }
        renderBebida(); fecharModal('mod-bebida'); toast('Salvo!');
    } catch(e) { toast('Erro ao salvar!', true); }
};

$('form-prod').onsubmit = async function(e) { 
    e.preventDefault(); 
    const nome = $('prod-nome').value.trim();
    if(!nome) { toast('Preencha o nome!', true); return; }
    const id = parseInt($('prod-id').value);
    const d = {nome, cat: $('prod-cat').value, ifood_p: parseFloat($('prod-if-p').value)||0, ifood_g: parseFloat($('prod-if-g').value)||0, anota_p: parseFloat($('prod-an-p').value)||0, anota_g: parseFloat($('prod-an-g').value)||0}; 
    try {
        if(id) { const r = await api('produtos', 'PUT', {...d, id}); const i = DB.produtos.findIndex(x=>x.id===id); if(i>=0) DB.produtos[i] = r; } 
        else { const r = await api('produtos', 'POST', d); DB.produtos.push(r); }
        renderProd(); atualizarFichaSelects(); fecharModal('mod-prod'); toast('Salvo!');
    } catch(e) { toast('Erro ao salvar!', true); }
};

$('form-combo').onsubmit = async function(e) { 
    e.preventDefault(); 
    const nome = $('combo-nome').value.trim();
    if(!nome) { toast('Preencha o nome!', true); return; }
    const id = parseInt($('combo-id').value);
    const d = {nome, preco_ifood: parseFloat($('combo-preco-if').value)||0, preco_anota: parseFloat($('combo-preco-an').value)||0, qp: parseInt($('combo-qp').value)||0, qg: parseInt($('combo-qg').value)||0, bebida_id: parseInt($('combo-bebida').value)||null, brinde_id: parseInt($('combo-brinde').value)||null}; 
    try {
        if(id) { const r = await api('combos', 'PUT', {...d, id}); const i = DB.combos.findIndex(x=>x.id===id); if(i>=0) DB.combos[i] = r; } 
        else { const r = await api('combos', 'POST', d); DB.combos.push(r); }
        renderCombo(); fecharModal('mod-combo'); toast('Salvo!');
    } catch(e) { toast('Erro ao salvar!', true); }
};

function atualizarSelectsCombo() {
    $('combo-bebida').innerHTML = '<option value="">Nenhuma</option>' + DB.bebidas.map(b=>`<option value="${b.id}">${b.nome}</option>`).join('');
    $('combo-brinde').innerHTML = '<option value="">Nenhum</option>' + DB.brindes.map(b=>`<option value="${b.id}">${b.nome}</option>`).join('');
}

// ==================== FICHAS ====================
function atualizarFichaSelects() {
    $('ficha-prod').innerHTML = '<option value="">Selecione...</option>' + DB.produtos.filter(p=>['macarrao','risoto','nhoque','salada'].includes(p.cat)).map(p=>`<option value="${p.id}">${p.nome}</option>`).join('');
    $('ficha-ing').innerHTML = '<option value="">Selecione...</option>' + DB.ingredientes.map(i=>`<option value="${i.id}">${i.nome} (${R$(i.custo)})</option>`).join('');
}

function carregarFicha() {
    const prodId = $('ficha-prod').value, tam = $('ficha-tam').value;
    if(!prodId) { $('ficha-area').style.display = 'none'; return; }
    $('ficha-area').style.display = 'block';
    renderFichaIngs(prodId, tam);
}

function renderFichaIngs(prodId, tam) {
    const fichaItems = DB.fichas.filter(f => f.produto_id == prodId && f.tamanho === tam);
    $('ficha-list').innerHTML = fichaItems.length === 0 ? '<div class="empty" style="padding:0.3rem;font-size:0.65rem;">Nenhum ingrediente</div>' : fichaItems.map(fi => {
        const ing = DB.ingredientes.find(i=>i.id===fi.ingrediente_id);
        if(!ing) return '';
        const custo = ing.custo * fi.qtd;
        return `<div class="ing-item"><div><b>${ing.nome}</b> <span style="color:var(--text3);font-size:0.55rem;">${fi.qtd}${ing.un}</span></div><div style="display:flex;align-items:center;gap:0.2rem;"><span class="mono" style="color:var(--green);font-size:0.6rem;">${R$(custo)}</span><button class="btn btn-d btn-sm" onclick="remIngFicha(${fi.id})">√ó</button></div></div>`;
    }).join('');
    calcFicha(prodId, tam);
}

async function addIngFicha() {
    const prodId = $('ficha-prod').value, tam = $('ficha-tam').value, ingId = parseInt($('ficha-ing').value), qtd = parseFloat($('ficha-qtd').value);
    if(!prodId || !ingId || !qtd) { toast('Preencha!', true); return; }
    try {
        const r = await api('fichas', 'POST', { produto_id: parseInt(prodId), tamanho: tam, ingrediente_id: ingId, qtd });
        DB.fichas = await api('fichas');
        carregarFicha(); 
        $('ficha-qtd').value = ''; 
        toast('Adicionado!');
    } catch(e) { toast('Erro!', true); }
}

async function remIngFicha(id) {
    try {
        await api('fichas', 'DELETE', { id });
        DB.fichas = DB.fichas.filter(f => f.id !== id);
        carregarFicha();
    } catch(e) { toast('Erro!', true); }
}

function calcFicha(prodId, tam) {
    const prod = DB.produtos.find(p=>p.id==prodId); if(!prod) return;
    const fichaItems = DB.fichas.filter(f => f.produto_id == prodId && f.tamanho === tam);
    let cIng = 0;
    fichaItems.forEach(fi => {
        const ing = DB.ingredientes.find(i=>i.id===fi.ingrediente_id);
        if(ing) cIng += ing.custo * fi.qtd;
    });
    const massaAvg = DB.massas.length > 0 ? (tam==='P' ? DB.massas.reduce((s,m)=>s+parseFloat(m.custo_p),0) : DB.massas.reduce((s,m)=>s+parseFloat(m.custo_g),0)) / DB.massas.length : 0;
    const cTotal = cIng + massaAvg;
    $('f-cing').textContent = R$(cIng); 
    $('f-cmassa').textContent = R$(massaAvg); 
    $('f-ctotal').textContent = R$(cTotal);
    $('f-preco-if').textContent = R$(tam==='P' ? prod.ifood_p : prod.ifood_g);
    $('f-preco-an').textContent = R$(tam==='P' ? prod.anota_p : prod.anota_g);
}

// ==================== IMPORT EXCEL ====================
const uploadBox = $('upload-box'), fileInput = $('file-input');
uploadBox.onclick = () => fileInput.click();
uploadBox.ondragover = e => { e.preventDefault(); uploadBox.classList.add('dragover'); };
uploadBox.ondragleave = () => uploadBox.classList.remove('dragover');
uploadBox.ondrop = e => { e.preventDefault(); uploadBox.classList.remove('dragover'); if(e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); };
fileInput.onchange = e => { if(e.target.files[0]) processFile(e.target.files[0]); };

function processFile(file) {
    $('upload-file').textContent = 'üìÑ ' + file.name;
    uploadBox.classList.add('has-file');
    showLoading(true);
    setTimeout(() => {
        const reader = new FileReader();
        reader.onload = ev => { try { const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'}); processarExcel(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1})); } catch(e) { toast('Erro!', true); } showLoading(false); };
        reader.onerror = () => { showLoading(false); toast('Erro!', true); };
        reader.readAsArrayBuffer(file);
    }, 100);
}

function identificarTamanho(nl) {
    if(nl.includes('box g') || nl.includes('800g')) return 'G';
    if(nl.includes('650g') || nl.includes('risoto')) return 'G';
    if(nl.includes('nhoque')) return 'G';
    if(nl.includes('box p') || nl.includes('450g') || nl.includes('box kids')) return 'P';
    return null;
}

function processarExcel(data) {
    let periodoDetectado = '';
    if(data[1] && data[1][0]) {
        const parts = String(data[1][0]).split('/');
        if(parts.length >= 2) periodoDetectado = parts[1] + '/' + parts[2];
    }
    
    const vendas = { grupos: [], itensCombo: [], totalQtd: 0, totalFat: 0, totalCusto: 0 };
    let isInsideCombo = false;
    
    for(let i = 5; i < data.length; i++) {
        const row = data[i];
        if(!row || row[0] === undefined) continue;
        
        const rawNome = String(row[0]).trim();
        const qty = parseInt(row[1]) || 0;
        const valor = parseFloat(row[2]) || 0;
        
        if(!rawNome || rawNome === 'nan') continue;
        
        const isSubItem = rawNome.startsWith('-') || rawNome.startsWith(' ');
        const nome = rawNome.replace(/^[\s\-]+/, '').trim();
        const nl = nome.toLowerCase();
        
        if(!isSubItem && qty > 0) {
            isInsideCombo = nl.includes('combo');
            vendas.grupos.push({ nome, qty, valor, isCombo: isInsideCombo });
            vendas.totalFat += valor;
            vendas.totalQtd += qty;
        } else if(isSubItem && isInsideCombo && qty > 0) {
            const tam = identificarTamanho(nl);
            if(tam) {
                vendas.itensCombo.push({ nome, qty, tam, tipo: nl.includes('risoto') ? 'risoto' : nl.includes('nhoque') ? 'nhoque' : 'macarrao' });
            } else if(nl.includes('coca') || nl.includes('sprite') || nl.includes('fanta') || nl.includes('suco') || nl.includes('√°gua')) {
                vendas.itensCombo.push({ nome, qty, tipo: 'bebida' });
            }
        }
    }
    
    importData = { periodoDetectado, vendas };
    mostrarPreview();
}

function mostrarPreview() {
    const v = importData.vendas;
    const meses = ['','Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    const anoAtual = new Date().getFullYear();
    
    let mesOpts = meses.map((m,i) => i > 0 ? `<option value="${String(i).padStart(2,'0')}" ${importData.periodoDetectado.startsWith(String(i).padStart(2,'0')) ? 'selected' : ''}>${m}</option>` : '').join('');
    let anoOpts = ''; for(let a = anoAtual - 2; a <= anoAtual + 1; a++) anoOpts += `<option value="${a}" ${importData.periodoDetectado.includes(String(a)) ? 'selected' : ''}>${a}</option>`;
    
    $('import-preview').innerHTML = `
        <div class="preview">
            <div class="form-row" style="margin-bottom:0.5rem;">
                <div class="field"><label>M√™s</label><select id="import-mes">${mesOpts}</select></div>
                <div class="field"><label>Ano</label><select id="import-ano">${anoOpts}</select></div>
                <div class="field"><label>Card√°pio *</label><select id="import-cardapio"><option value="">Selecione</option><option value="ifood">üì± iFood</option><option value="anotaai">üì≤ AnotaAi</option></select></div>
            </div>
            <div class="res-box" style="margin-bottom:0.4rem;grid-template-columns:repeat(3,1fr);">
                <div class="res-item"><div class="lbl">Grupos</div><div class="val" style="color:var(--blue);">${v.grupos.length}</div></div>
                <div class="res-item"><div class="lbl">Itens</div><div class="val" style="color:var(--purple);">${v.totalQtd}</div></div>
                <div class="res-item"><div class="lbl">Faturamento</div><div class="val" style="color:var(--green);">${R$(v.totalFat)}</div></div>
            </div>
            <div style="max-height:100px;overflow-y:auto;margin-bottom:0.4rem;">
                ${v.grupos.sort((a,b)=>b.valor-a.valor).slice(0,5).map(g => `<div class="prev-group"><span>${g.nome.slice(0,20)}${g.isCombo?' üéØ':''}</span><span class="mono">${R$(g.valor)}</span></div>`).join('')}
            </div>
            <div style="display:flex;gap:0.3rem;">
                <button class="btn btn-p" style="flex:1;" onclick="confirmarImport()">‚úÖ Confirmar</button>
                <button class="btn btn-s" onclick="cancelarImport()">‚ùå</button>
            </div>
        </div>
    `;
}

async function confirmarImport() {
    const mes = $('import-mes').value, ano = $('import-ano').value, cardapio = $('import-cardapio').value;
    if(!mes || !ano || !cardapio) { toast('Preencha m√™s, ano e card√°pio!', true); return; }
    
    const v = importData.vendas;
    let totalCusto = v.totalFat * 0.32; // Estimativa inicial 32%
    
    try {
        const r = await api('vendas', 'POST', {
            mes, ano, cardapio,
            grupos: v.grupos,
            itens_combo: v.itensCombo,
            total_qtd: v.totalQtd,
            total_fat: v.totalFat,
            total_custo: totalCusto
        });
        
        DB.vendas = await api('vendas');
        toast(`Importado: ${mes}/${ano} - ${cardapio === 'ifood' ? 'iFood' : 'AnotaAi'}`);
        cancelarImport();
        renderMeses();
        atualizarDash();
    } catch(e) { toast('Erro ao importar!', true); }
}

function cancelarImport() {
    importData = null;
    $('import-preview').innerHTML = '';
    $('file-input').value = '';
    $('upload-file').textContent = '';
    uploadBox.classList.remove('has-file');
}

// ==================== AN√ÅLISE ====================
$('sel-mes').onchange = function() {
    const id = parseInt(this.value);
    const v = DB.vendas.find(x => x.id === id);
    if(!v) { $('analise-area').innerHTML = ''; return; }
    
    const grupos = typeof v.grupos === 'string' ? JSON.parse(v.grupos) : v.grupos;
    const cmv = v.total_fat > 0 ? ((v.total_custo/v.total_fat)*100).toFixed(1) : '0';
    
    $('analise-area').innerHTML = `
        <div class="alert ${v.cardapio==='ifood'?'info':'ok'}">üìä Dados do <span class="cardapio-tag ${v.cardapio}">${v.cardapio==='ifood'?'iFood':'AnotaAi'}</span></div>
        <div class="grid-kpi" style="grid-template-columns:repeat(4,1fr);">
            <div class="kpi green"><div class="kpi-label">Fat.</div><div class="kpi-value">${R$(v.total_fat)}</div></div>
            <div class="kpi blue"><div class="kpi-label">Custo</div><div class="kpi-value">${R$(v.total_custo)}</div></div>
            <div class="kpi yellow"><div class="kpi-label">CMV</div><div class="kpi-value">${cmv}%</div></div>
            <div class="kpi purple"><div class="kpi-label">Lucro</div><div class="kpi-value">${R$(v.total_fat - v.total_custo)}</div></div>
        </div>
        <div class="card">
            <div class="card-title">üìä Por Grupo</div>
            <div class="tbl-wrap" style="margin-top:0.4rem;"><table><thead><tr><th>Grupo</th><th>Qtd</th><th>Fat.</th><th>%</th></tr></thead>
            <tbody>${grupos.sort((a,b)=>b.valor-a.valor).map(g => `<tr><td><b>${g.nome.slice(0,20)}</b>${g.isCombo?' üéØ':''}</td><td class="mono">${g.qty}</td><td class="mono">${R$(g.valor)}</td><td class="mono">${v.total_fat>0?((g.valor/v.total_fat)*100).toFixed(0):0}%</td></tr>`).join('')}</tbody></table></div>
        </div>
    `;
};

// ==================== COMPARAR ====================
function compararMeses() {
    const id1 = parseInt($('comp-mes1').value), id2 = parseInt($('comp-mes2').value);
    const v1 = DB.vendas.find(x => x.id === id1), v2 = DB.vendas.find(x => x.id === id2);
    if(!v1 || !v2) { toast('Selecione 2 per√≠odos!', true); return; }
    
    const cmv1 = v1.total_fat > 0 ? (v1.total_custo/v1.total_fat)*100 : 0;
    const cmv2 = v2.total_fat > 0 ? (v2.total_custo/v2.total_fat)*100 : 0;
    
    const diff = (a, b) => { const d = b - a; const p = a > 0 ? ((d/a)*100).toFixed(0) : 0; return d >= 0 ? `<span class="compare-diff up">‚ñ≤${p}%</span>` : `<span class="compare-diff down">‚ñº${Math.abs(p)}%</span>`; };
    
    $('compare-area').innerHTML = `
        <div class="card">
            <div class="card-title">üìä Comparativo</div>
            <div class="compare-grid" style="margin-top:0.4rem;">
                <div class="compare-col">
                    <div class="compare-header"><span class="cardapio-tag ${v1.cardapio}">${v1.cardapio==='ifood'?'iFood':'AnotaAi'}</span> ${v1.mes}/${v1.ano}</div>
                    <div class="compare-item"><span>Faturamento</span><span class="mono">${R$(v1.total_fat)}</span></div>
                    <div class="compare-item"><span>Custo</span><span class="mono">${R$(v1.total_custo)}</span></div>
                    <div class="compare-item"><span>CMV</span><span class="mono">${cmv1.toFixed(1)}%</span></div>
                    <div class="compare-item"><span>Lucro</span><span class="mono">${R$(v1.total_fat - v1.total_custo)}</span></div>
                </div>
                <div class="compare-col">
                    <div class="compare-header"><span class="cardapio-tag ${v2.cardapio}">${v2.cardapio==='ifood'?'iFood':'AnotaAi'}</span> ${v2.mes}/${v2.ano}</div>
                    <div class="compare-item"><span>Faturamento</span><span class="mono">${R$(v2.total_fat)} ${diff(v1.total_fat,v2.total_fat)}</span></div>
                    <div class="compare-item"><span>Custo</span><span class="mono">${R$(v2.total_custo)} ${diff(v1.total_custo,v2.total_custo)}</span></div>
                    <div class="compare-item"><span>CMV</span><span class="mono">${cmv2.toFixed(1)}% ${cmv2<=cmv1?'<span class="compare-diff up">‚ñº</span>':'<span class="compare-diff down">‚ñ≤</span>'}</span></div>
                    <div class="compare-item"><span>Lucro</span><span class="mono">${R$(v2.total_fat - v2.total_custo)} ${diff(v1.total_fat-v1.total_custo,v2.total_fat-v2.total_custo)}</span></div>
                </div>
            </div>
        </div>
    `;
}

// ==================== DASHBOARD ====================
function atualizarDash() {
    if(DB.vendas.length === 0) {
        $('k-fat').textContent = 'R$ 0'; $('k-custo').textContent = 'R$ 0'; $('k-cmv').textContent = '0%'; $('k-lucro').textContent = 'R$ 0'; $('k-itens').textContent = '0';
        $('tbl-dash').innerHTML = '<tr><td colspan="4"><div class="empty"><div class="empty-icon">üìä</div>Importe vendas</div></td></tr>';
        if(chart1) { chart1.destroy(); chart1 = null; } if(chart2) { chart2.destroy(); chart2 = null; }
        return;
    }
    
    const v = DB.vendas[DB.vendas.length - 1];
    const grupos = typeof v.grupos === 'string' ? JSON.parse(v.grupos) : v.grupos;
    
    $('k-fat').textContent = R$(v.total_fat); $('k-custo').textContent = R$(v.total_custo);
    const cmv = v.total_fat > 0 ? ((v.total_custo/v.total_fat)*100) : 0;
    $('k-cmv').textContent = cmv.toFixed(0) + '%'; $('k-lucro').textContent = R$(v.total_fat - v.total_custo); $('k-itens').textContent = v.total_qtd;
    
    $('tbl-dash').innerHTML = grupos.sort((a,b)=>b.valor-a.valor).slice(0,6).map(g => `<tr><td><b>${g.nome.slice(0,16)}</b></td><td class="mono">${g.qty}</td><td class="mono">${R$(g.valor)}</td><td class="mono">${v.total_fat>0?((g.valor/v.total_fat)*100).toFixed(0):0}%</td></tr>`).join('');
    
    atualizarCharts(grupos);
}

function atualizarCharts(grupos) {
    if(!grupos || grupos.length === 0) return;
    
    const labels1 = grupos.sort((a,b)=>b.valor-a.valor).slice(0,5).map(g => g.nome.slice(0,8));
    const valores1 = grupos.sort((a,b)=>b.valor-a.valor).slice(0,5).map(g => g.valor);
    
    if(chart1) chart1.destroy();
    chart1 = new Chart($('chart1'), {
        type: 'bar', data: { labels: labels1, datasets: [{ data: valores1, backgroundColor: ['#10b981','#3b82f6','#f59e0b','#8b5cf6','#ec4899'], borderRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#64748b', font: { size: 8 } } }, x: { ticks: { color: '#94a3b8', maxRotation: 45, font: { size: 7 } } } } }
    });
    
    if(DB.vendas.length >= 2) {
        const labels2 = DB.vendas.slice(-6).map(v => `${v.mes}/${v.ano.slice(-2)}`);
        const cmvData = DB.vendas.slice(-6).map(v => v.total_fat > 0 ? ((v.total_custo/v.total_fat)*100).toFixed(1) : 0);
        
        if(chart2) chart2.destroy();
        chart2 = new Chart($('chart2'), {
            type: 'line', data: { labels: labels2, datasets: [{ label: 'CMV %', data: cmvData, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', fill: true, tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#64748b', font: { size: 8 }, callback: v => v + '%' } }, x: { ticks: { color: '#94a3b8', font: { size: 7 } } } } }
        });
    }
}

// ==================== CONFIG ====================
async function setupDB() {
    if(!confirm('Criar tabelas no banco de dados?')) return;
    showLoading(true);
    try {
        await api('setup', 'POST');
        toast('Tabelas criadas!');
    } catch(e) { toast('Erro: ' + e.message, true); }
    showLoading(false);
}

async function seedDB() {
    if(!confirm('Popular dados iniciais? (Isso vai substituir dados existentes)')) return;
    showLoading(true);
    try {
        await api('seed', 'POST');
        await loadAll();
        toast('Dados iniciais carregados!');
    } catch(e) { toast('Erro: ' + e.message, true); }
    showLoading(false);
}

function limparDados() { 
    if(confirm('‚ö†Ô∏è APAGAR TUDO do banco?')) { 
        toast('Use o console do Neon para limpar tabelas', true); 
    }
}

// ==================== INIT ====================
function renderAll() { renderIng(); renderMassa(); renderExtra(); renderBebida(); renderProd(); renderCombo(); renderMeses(); atualizarFichaSelects(); atualizarDash(); }

document.addEventListener('DOMContentLoaded', () => {
    $('dataAtual').textContent = new Date().toLocaleDateString('pt-BR');
    document.querySelectorAll('.modal-bg').forEach(m => { m.onclick = e => { if(e.target === m) { m.classList.remove('show'); document.body.style.overflow = ''; }}; });
    loadAll();
});
</script>
</body>
</html>
