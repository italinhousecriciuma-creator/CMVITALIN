<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0f1c">
    <title>CMV Control - Ital'in House</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --bg-hover: #243049;
            --green: #10b981;
            --red: #ef4444;
            --yellow: #f59e0b;
            --blue: #3b82f6;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --cyan: #06b6d4;
            --orange: #f97316;
            --text: #f1f5f9;
            --text2: #94a3b8;
            --text3: #64748b;
            --border: #2d3a52;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text); min-height: 100vh; padding-bottom: 100px; }
        
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 0.7rem 1rem; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 0.5rem; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--green), var(--blue)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
        .logo h1 { font-size: 0.95rem; font-weight: 700; }
        .logo span { font-size: 0.55rem; color: var(--text3); display: block; }
        .header-right { display: flex; align-items: center; gap: 0.5rem; }
        .header-date { font-family: 'Space Mono', monospace; color: var(--green); font-size: 0.65rem; }
        .sync-status { display: flex; align-items: center; gap: 0.25rem; font-size: 0.55rem; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .sync-status.online { background: rgba(16,185,129,0.2); color: var(--green); }
        .sync-status.offline { background: rgba(239,68,68,0.2); color: var(--red); }
        
        .nav { background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 48px; z-index: 99; }
        .nav-content { display: flex; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding: 0 0.5rem; }
        .nav-content::-webkit-scrollbar { display: none; }
        .nav-btn { background: none; border: none; color: var(--text2); padding: 0.7rem 0.7rem; font-family: inherit; font-size: 0.65rem; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; transition: all 0.15s; flex-shrink: 0; }
        .nav-btn:hover, .nav-btn:active { color: var(--text); background: var(--bg-hover); }
        .nav-btn.active { color: var(--green); border-bottom-color: var(--green); background: rgba(16,185,129,0.1); }
        
        .main { max-width: 1400px; margin: 0 auto; padding: 0.9rem; }
        .page { display: none; animation: fadeIn 0.2s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .grid-kpi { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 0.9rem; }
        @media (max-width: 600px) { .grid-kpi { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 400px) { .grid-kpi { grid-template-columns: repeat(2, 1fr); } }
        .kpi { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 0.6rem; position: relative; overflow: hidden; }
        .kpi::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
        .kpi.green::before { background: var(--green); }
        .kpi.blue::before { background: var(--blue); }
        .kpi.yellow::before { background: var(--yellow); }
        .kpi.purple::before { background: var(--purple); }
        .kpi.red::before { background: var(--red); }
        .kpi-label { color: var(--text2); font-size: 0.55rem; margin-bottom: 0.15rem; text-transform: uppercase; }
        .kpi-value { font-family: 'Space Mono', monospace; font-size: 0.9rem; font-weight: 700; }
        .kpi.green .kpi-value { color: var(--green); }
        .kpi.blue .kpi-value { color: var(--blue); }
        .kpi.yellow .kpi-value { color: var(--yellow); }
        .kpi.purple .kpi-value { color: var(--purple); }
        .kpi.red .kpi-value { color: var(--red); }
        
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem; }
        .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem; flex-wrap: wrap; gap: 0.4rem; }
        .card-title { font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 0.3rem; }
        .card-actions { display: flex; gap: 0.3rem; align-items: center; flex-wrap: wrap; }
        
        .search-box { display: flex; align-items: center; gap: 0.3rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; padding: 0.3rem 0.5rem; }
        .search-box input { background: none; border: none; color: var(--text); font-size: 0.7rem; width: 100px; outline: none; }
        .search-box input::placeholder { color: var(--text3); }
        
        .tbl-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid var(--border); border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.68rem; }
        th { background: var(--bg-secondary); color: var(--text2); font-weight: 600; text-align: left; padding: 0.45rem 0.35rem; border-bottom: 1px solid var(--border); white-space: nowrap; cursor: pointer; user-select: none; }
        th:hover { background: var(--bg-hover); }
        td { padding: 0.4rem 0.35rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover td { background: var(--bg-hover); }
        tr:last-child td { border-bottom: none; }
        
        .badge { display: inline-block; padding: 0.1rem 0.35rem; border-radius: 4px; font-size: 0.55rem; font-weight: 600; }
        .badge.green { background: rgba(16,185,129,0.2); color: var(--green); }
        .badge.yellow { background: rgba(245,158,11,0.2); color: var(--yellow); }
        .badge.red { background: rgba(239,68,68,0.2); color: var(--red); }
        .badge.blue { background: rgba(59,130,246,0.2); color: var(--blue); }
        .badge.purple { background: rgba(139,92,246,0.2); color: var(--purple); }
        .badge.cyan { background: rgba(6,182,212,0.2); color: var(--cyan); }
        .badge.orange { background: rgba(249,115,22,0.2); color: var(--orange); }
        .badge.pink { background: rgba(236,72,153,0.2); color: var(--pink); }
        
        .mono { font-family: 'Space Mono', monospace; }
        
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; }
        .field { margin-bottom: 0.5rem; }
        .field label { display: block; color: var(--text2); font-size: 0.65rem; margin-bottom: 0.15rem; font-weight: 500; }
        .field input, .field select { width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem 0.6rem; color: var(--text); font-family: inherit; font-size: 0.8rem; }
        .field input:focus, .field select:focus { outline: none; border-color: var(--green); }
        .field-row { display: flex; gap: 0.3rem; align-items: flex-end; }
        .field-row .field { flex: 1; margin-bottom: 0; }
        .field-row .field.small { flex: 0 0 70px; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.25rem; padding: 0.5rem 0.9rem; border: none; border-radius: 6px; font-family: inherit; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.15s; min-height: 36px; touch-action: manipulation; position: relative; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-p { background: linear-gradient(135deg, var(--green), var(--blue)); color: white; }
        .btn-p:hover:not(:disabled) { opacity: 0.9; }
        .btn-d { background: rgba(239,68,68,0.15); color: var(--red); }
        .btn-e { background: rgba(59,130,246,0.15); color: var(--blue); }
        .btn-s { background: var(--bg-secondary); color: var(--text); border: 1px solid var(--border); }
        .btn-sm { padding: 0.35rem 0.5rem; font-size: 0.65rem; min-height: 32px; }
        .btn-loading .btn-text { visibility: hidden; }
        .btn-loading::after { content: ''; position: absolute; width: 14px; height: 14px; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .actions { display: flex; gap: 0.2rem; justify-content: flex-end; }
        
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: flex-end; justify-content: center; }
        .modal-bg.show { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px 16px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: 1rem; animation: slideUp 0.2s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
        .modal-head h3 { font-size: 0.9rem; }
        .modal-close { background: var(--bg-secondary); border: none; color: var(--text); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }
        .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 0.8rem; }
        @media (min-width: 600px) { .modal-bg { align-items: center; padding: 1rem; } .modal { border-radius: 12px; } .modal-handle { display: none; } }
        
        .confirm-modal { text-align: center; padding: 1rem; }
        .confirm-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .confirm-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.3rem; }
        .confirm-text { font-size: 0.75rem; color: var(--text2); margin-bottom: 1rem; }
        .confirm-btns { display: flex; gap: 0.5rem; justify-content: center; }
        
        .upload-box { border: 2px dashed var(--border); border-radius: 10px; padding: 1.2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .upload-box:hover, .upload-box.dragover { border-color: var(--green); background: rgba(16,185,129,0.05); }
        .upload-box.has-file { border-color: var(--green); border-style: solid; }
        .upload-icon { font-size: 1.8rem; margin-bottom: 0.3rem; }
        .upload-text { font-size: 0.75rem; color: var(--text2); }
        .upload-file { font-size: 0.7rem; color: var(--green); margin-top: 0.3rem; font-weight: 600; }
        
        .alert { padding: 0.5rem 0.7rem; border-radius: 6px; font-size: 0.7rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.3rem; }
        .alert.info { background: rgba(59,130,246,0.15); color: var(--blue); }
        .alert.warn { background: rgba(245,158,11,0.15); color: var(--yellow); }
        .alert.ok { background: rgba(16,185,129,0.15); color: var(--green); }
        .alert.error { background: rgba(239,68,68,0.15); color: var(--red); }
        
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .toast { background: var(--bg-card); border: 1px solid var(--green); padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.75rem; display: flex; align-items: center; gap: 0.4rem; box-shadow: 0 4px 20px rgba(0,0,0,0.4); animation: toastIn 0.3s ease; }
        .toast.error { border-color: var(--red); }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; }
        
        .ing-list { border: 1px solid var(--border); border-radius: 6px; max-height: 200px; overflow-y: auto; }
        .ing-item { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.5rem; border-bottom: 1px solid var(--border); font-size: 0.7rem; }
        .ing-item:last-child { border-bottom: none; }
        
        .res-box { background: var(--bg-secondary); border-radius: 6px; padding: 0.6rem; display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.4rem; margin-top: 0.6rem; }
        @media (max-width: 400px) { .res-box { grid-template-columns: repeat(2, 1fr); } }
        .res-item { text-align: center; }
        .res-item .lbl { font-size: 0.5rem; color: var(--text3); text-transform: uppercase; }
        .res-item .val { font-family: 'Space Mono', monospace; font-size: 0.8rem; font-weight: 700; }
        
        .empty { text-align: center; padding: 1.2rem; color: var(--text3); font-size: 0.75rem; }
        .empty-icon { font-size: 1.5rem; margin-bottom: 0.3rem; opacity: 0.5; }
        
        .chart-box { height: 180px; }
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 0.8rem; }
        @media (min-width: 650px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .preview { background: var(--bg-secondary); border-radius: 8px; padding: 0.8rem; margin-top: 0.8rem; }
        .prev-group { background: var(--bg-card); border-radius: 4px; padding: 0.5rem; margin-bottom: 0.3rem; display: flex; justify-content: space-between; font-size: 0.7rem; }
        
        .cardapio-tag { display: inline-flex; align-items: center; gap: 0.2rem; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.6rem; font-weight: 600; }
        .cardapio-tag.ifood { background: rgba(234,67,53,0.2); color: #ea4335; }
        .cardapio-tag.anotaai { background: rgba(52,168,83,0.2); color: #34a853; }
        
        .section-title { font-size: 0.75rem; color: var(--text2); margin: 0.8rem 0 0.4rem; font-weight: 600; border-bottom: 1px solid var(--border); padding-bottom: 0.2rem; }
        
        .dual-price { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .dual-price .price-col { background: var(--bg-secondary); border-radius: 6px; padding: 0.5rem; }
        .dual-price .price-col h4 { font-size: 0.65rem; margin-bottom: 0.3rem; display: flex; align-items: center; gap: 0.3rem; }
        .dual-price .price-col.ifood h4 { color: #ea4335; }
        .dual-price .price-col.anotaai h4 { color: #34a853; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üçù</div>
                <div><h1>CMV Control</h1><span>Ital'in House v10</span></div>
            </div>
            <div class="header-right">
                <div class="sync-status online" id="sync-status">‚òÅÔ∏è Online</div>
                <div class="header-date" id="dataAtual"></div>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="nav-content">
            <button class="nav-btn active" data-p="dashboard">üìä Dash</button>
            <button class="nav-btn" data-p="produtos">üçΩÔ∏è Produtos</button>
            <button class="nav-btn" data-p="massas">üçù Massas</button>
            <button class="nav-btn" data-p="extras">‚ûï Extras</button>
            <button class="nav-btn" data-p="ingredientes">üßÖ Ingredientes</button>
            <button class="nav-btn" data-p="fichas">üìã Fichas</button>
            <button class="nav-btn" data-p="importar">üì• Importar</button>
            <button class="nav-btn" data-p="analise">üìà An√°lise</button>
            <button class="nav-btn" data-p="config">‚öôÔ∏è Config</button>
        </div>
    </nav>

    <main class="main">
        <!-- DASHBOARD -->
        <div class="page active" id="p-dashboard">
            <div class="grid-kpi">
                <div class="kpi green"><div class="kpi-label">Faturamento</div><div class="kpi-value" id="k-fat">R$ 0</div></div>
                <div class="kpi blue"><div class="kpi-label">Custo Real</div><div class="kpi-value" id="k-custo">R$ 0</div></div>
                <div class="kpi yellow"><div class="kpi-label">CMV</div><div class="kpi-value" id="k-cmv">0%</div></div>
                <div class="kpi purple"><div class="kpi-label">Lucro</div><div class="kpi-value" id="k-lucro">R$ 0</div></div>
                <div class="kpi red"><div class="kpi-label">Itens</div><div class="kpi-value" id="k-itens">0</div></div>
            </div>
            <div class="chart-grid">
                <div class="card"><div class="card-title">üìä Top Produtos</div><div class="chart-box"><canvas id="chart1"></canvas></div></div>
                <div class="card"><div class="card-title">üìà CMV Mensal</div><div class="chart-box"><canvas id="chart2"></canvas></div></div>
            </div>
            <div class="card">
                <div class="card-title">üìã √öltimas Vendas</div>
                <div class="tbl-wrap" style="margin-top:0.5rem;"><table><thead><tr><th>Per√≠odo</th><th>Card.</th><th>Fat.</th><th>Custo</th><th>CMV</th></tr></thead><tbody id="tbl-dash"></tbody></table></div>
            </div>
        </div>

        <!-- PRODUTOS -->
        <div class="page" id="p-produtos">
            <div class="card">
                <div class="card-head">
                    <span class="card-title">üçΩÔ∏è Produtos</span>
                    <div class="card-actions">
                        <div class="search-box"><span>üîç</span><input type="text" id="search-prod" placeholder="Buscar..." oninput="filtrarProd()"></div>
                        <button class="btn btn-p" onclick="abrirModal('mod-prod')">+ Novo</button>
                    </div>
                </div>
                <div class="alert info">üí° Cadastre os produtos com custo base (molho + massa padr√£o inclusos)</div>
                <div class="tbl-wrap"><table><thead><tr><th>Nome</th><th>Cat</th><th>Custo P</th><th>Custo G</th><th></th></tr></thead><tbody id="tbl-prod"></tbody></table></div>
            </div>
        </div>

        <!-- MASSAS PREMIUM -->
        <div class="page" id="p-massas">
            <div class="card">
                <div class="card-head">
                    <span class="card-title">üçù Massas Premium</span>
                    <button class="btn btn-p" onclick="abrirModal('mod-massa')">+ Nova</button>
                </div>
                <div class="alert info">üí° Massas com custo adicional (Talharim, Penne Integral, Proteico). Penne e Caracolino s√£o padr√£o (custo j√° no produto).</div>
                <div class="tbl-wrap"><table><thead><tr><th>Massa</th><th>iFood</th><th>AnotaAi</th><th></th></tr></thead><tbody id="tbl-massa"></tbody></table></div>
            </div>
        </div>

        <!-- EXTRAS -->
        <div class="page" id="p-extras">
            <div class="card">
                <div class="card-head">
                    <span class="card-title">‚ûï Extras</span>
                    <div class="card-actions">
                        <div class="search-box"><span>üîç</span><input type="text" id="search-extra" placeholder="Buscar..." oninput="filtrarExtra()"></div>
                        <button class="btn btn-p" onclick="abrirModal('mod-extra')">+ Novo</button>
                    </div>
                </div>
                <div class="alert info">üí° Cadastre o CUSTO de cada extra (bacon, queijo, carne mo√≠da, etc)</div>
                <div class="tbl-wrap"><table><thead><tr><th>Nome</th><th>Custo</th><th></th></tr></thead><tbody id="tbl-extra"></tbody></table></div>
            </div>
        </div>

        <!-- INGREDIENTES -->
        <div class="page" id="p-ingredientes">
            <div class="card">
                <div class="card-head">
                    <span class="card-title">üßÖ Ingredientes</span>
                    <div class="card-actions">
                        <div class="search-box"><span>üîç</span><input type="text" id="search-ing" placeholder="Buscar..." oninput="filtrarIng()"></div>
                        <button class="btn btn-p" onclick="abrirModal('mod-ing')">+ Novo</button>
                    </div>
                </div>
                <div class="tbl-wrap"><table><thead><tr><th>Nome</th><th>Unidade</th><th>Custo/Un</th><th>Forn.</th><th></th></tr></thead><tbody id="tbl-ing"></tbody></table></div>
            </div>
        </div>

        <!-- FICHAS T√âCNICAS -->
        <div class="page" id="p-fichas">
            <div class="card">
                <div class="card-title" style="margin-bottom:0.6rem;">üìã Fichas T√©cnicas</div>
                <div class="alert info">üí° Monte a ficha t√©cnica com os ingredientes. O custo ser√° calculado automaticamente.</div>
                <div class="form-row">
                    <div class="field"><label>Produto</label><select id="ficha-prod" onchange="carregarFicha()"></select></div>
                    <div class="field"><label>Tamanho</label><select id="ficha-tam" onchange="carregarFicha()"><option value="P">Box P (450g)</option><option value="G" selected>Box G (800g)</option></select></div>
                </div>
                <div id="ficha-area" style="display:none;">
                    <div style="background:var(--bg-secondary);border-radius:8px;padding:0.6rem;margin-top:0.5rem;">
                        <div style="font-size:0.7rem;font-weight:600;margin-bottom:0.4rem;">üßÖ Adicionar Ingrediente</div>
                        <div class="field-row">
                            <div class="field"><select id="ficha-ing" style="font-size:0.75rem;"></select></div>
                            <div class="field small"><input type="number" id="ficha-qtd" placeholder="Qtd" step="0.001" style="font-size:0.85rem;text-align:center;"></div>
                            <div class="field small"><select id="ficha-un" style="font-size:0.75rem;"><option>kg</option><option selected>g</option><option>L</option><option>ml</option><option>un</option></select></div>
                            <button class="btn btn-p btn-sm" onclick="addIngFicha()">+</button>
                        </div>
                        <div class="ing-list" id="ficha-list" style="margin-top:0.4rem;"></div>
                    </div>
                    <div class="res-box">
                        <div class="res-item"><div class="lbl">Ingredientes</div><div class="val" style="color:var(--yellow);" id="f-cing">R$0</div></div>
                        <div class="res-item"><div class="lbl">Custo Total</div><div class="val" style="color:var(--green);" id="f-ctotal">R$0</div></div>
                        <div class="res-item"><div class="lbl">Pre√ßo Venda</div><div class="val" style="color:var(--blue);" id="f-preco">R$0</div></div>
                        <div class="res-item"><div class="lbl">CMV</div><div class="val" style="color:var(--purple);" id="f-cmv">0%</div></div>
                    </div>
                    <button class="btn btn-p" style="width:100%;margin-top:0.6rem;" onclick="salvarCustoProduto()">üíæ Salvar Custo no Produto</button>
                </div>
            </div>
        </div>

        <!-- IMPORTAR -->
        <div class="page" id="p-importar">
            <div class="card">
                <div class="card-title" style="margin-bottom:0.6rem;">üì• Importar Vendas Excel</div>
                <div class="upload-box" id="upload-box">
                    <div class="upload-icon">üìÅ</div>
                    <p class="upload-text">Arraste ou clique para selecionar</p>
                    <p class="upload-file" id="upload-file"></p>
                    <input type="file" id="file-input" accept=".xlsx,.xls" style="display:none">
                </div>
                <div id="import-preview"></div>
            </div>
            <div class="card">
                <div class="card-head"><span class="card-title">üìÖ Importa√ß√µes</span></div>
                <div class="tbl-wrap"><table><thead><tr><th>Per√≠odo</th><th>Card.</th><th>Fat.</th><th>Custo</th><th>CMV</th><th></th></tr></thead><tbody id="tbl-meses"></tbody></table></div>
            </div>
        </div>

        <!-- AN√ÅLISE -->
        <div class="page" id="p-analise">
            <div class="card">
                <div class="card-head">
                    <span class="card-title">üìà An√°lise Detalhada</span>
                    <select id="sel-mes" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:0.4rem;color:var(--text);font-size:0.7rem;"></select>
                </div>
            </div>
            <div id="analise-area"></div>
        </div>

        <!-- CONFIG -->
        <div class="page" id="p-config">
            <div class="card">
                <div class="card-title" style="margin-bottom:0.6rem;">‚öôÔ∏è Configura√ß√µes</div>
                <div class="alert info">‚òÅÔ∏è Dados salvos no servidor PostgreSQL (Neon)</div>
                <div style="margin-top:0.6rem;display:flex;gap:0.5rem;flex-wrap:wrap;">
                    <button class="btn btn-s" onclick="setupDB()">üîß Setup DB</button>
                    <button class="btn btn-s" onclick="seedDB()">üå± Dados Iniciais</button>
                    <button class="btn btn-s" onclick="exportarBackup()">üì§ Backup</button>
                </div>
            </div>
            <div class="card">
                <div class="card-title" style="margin-bottom:0.5rem;">üìä Estat√≠sticas</div>
                <div class="res-box" style="grid-template-columns:repeat(4,1fr);">
                    <div class="res-item"><div class="lbl">Produtos</div><div class="val" style="color:var(--blue);" id="stat-prod">0</div></div>
                    <div class="res-item"><div class="lbl">Ingredientes</div><div class="val" style="color:var(--yellow);" id="stat-ing">0</div></div>
                    <div class="res-item"><div class="lbl">Extras</div><div class="val" style="color:var(--green);" id="stat-extra">0</div></div>
                    <div class="res-item"><div class="lbl">Vendas</div><div class="val" style="color:var(--purple);" id="stat-vendas">0</div></div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <div class="modal-bg" id="mod-prod"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><h3>Produto</h3><button class="modal-close" onclick="fecharModal('mod-prod')">√ó</button></div>
        <form id="form-prod"><input type="hidden" id="prod-id">
            <div class="form-row">
                <div class="field"><label>Nome *</label><input type="text" id="prod-nome" required placeholder="Ex: Bolonhesa"></div>
                <div class="field"><label>Categoria</label><select id="prod-cat"><option value="macarrao">Macarr√£o</option><option value="risoto">Risoto</option><option value="nhoque">Nhoque</option><option value="outros">Outros</option></select></div>
            </div>
            <div class="section-title">üí∞ Custo Base (Molho + Massa Padr√£o)</div>
            <div class="form-row">
                <div class="field"><label>Custo Box P (R$)</label><input type="number" id="prod-custo-p" step="0.01" min="0" placeholder="0.00"></div>
                <div class="field"><label>Custo Box G (R$)</label><input type="number" id="prod-custo-g" step="0.01" min="0" placeholder="0.00"></div>
            </div>
            <div class="section-title">üíµ Pre√ßo de Venda (opcional, para c√°lculo CMV)</div>
            <div class="form-row">
                <div class="field"><label>Pre√ßo Box P (R$)</label><input type="number" id="prod-preco-p" step="0.01" min="0" placeholder="0.00"></div>
                <div class="field"><label>Pre√ßo Box G (R$)</label><input type="number" id="prod-preco-g" step="0.01" min="0" placeholder="0.00"></div>
            </div>
            <button type="submit" class="btn btn-p" style="width:100%;margin-top:0.6rem;"><span class="btn-text">üíæ Salvar</span></button>
        </form>
    </div></div>

    <div class="modal-bg" id="mod-massa"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><h3>Massa Premium</h3><button class="modal-close" onclick="fecharModal('mod-massa')">√ó</button></div>
        <form id="form-massa"><input type="hidden" id="massa-id">
            <div class="field"><label>Nome da Massa *</label><input type="text" id="massa-nome" required placeholder="Ex: Talharim"></div>
            <div class="section-title">üí∞ Custo Adicional por Plataforma</div>
            <div class="dual-price">
                <div class="price-col ifood">
                    <h4>üì± iFood</h4>
                    <div class="field"><label>Custo Extra (R$)</label><input type="number" id="massa-custo-if" step="0.01" min="0" placeholder="0.00"></div>
                </div>
                <div class="price-col anotaai">
                    <h4>üì≤ AnotaAi</h4>
                    <div class="field"><label>Custo Extra (R$)</label><input type="number" id="massa-custo-an" step="0.01" min="0" placeholder="0.00"></div>
                </div>
            </div>
            <button type="submit" class="btn btn-p" style="width:100%;margin-top:0.6rem;"><span class="btn-text">üíæ Salvar</span></button>
        </form>
    </div></div>

    <div class="modal-bg" id="mod-extra"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><h3>Extra</h3><button class="modal-close" onclick="fecharModal('mod-extra')">√ó</button></div>
        <form id="form-extra"><input type="hidden" id="extra-id">
            <div class="field"><label>Nome *</label><input type="text" id="extra-nome" required placeholder="Ex: Extra Bacon"></div>
            <div class="field"><label>Custo (R$) *</label><input type="number" id="extra-custo" step="0.01" min="0" placeholder="0.00"></div>
            <button type="submit" class="btn btn-p" style="width:100%;margin-top:0.5rem;"><span class="btn-text">üíæ Salvar</span></button>
        </form>
    </div></div>

    <div class="modal-bg" id="mod-ing"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><h3>Ingrediente</h3><button class="modal-close" onclick="fecharModal('mod-ing')">√ó</button></div>
        <form id="form-ing"><input type="hidden" id="ing-id">
            <div class="form-row">
                <div class="field"><label>Nome *</label><input type="text" id="ing-nome" required placeholder="Ex: Queijo Mu√ßarela"></div>
                <div class="field"><label>Unidade *</label><select id="ing-un"><option value="kg">kg</option><option value="g">g</option><option value="L">L</option><option value="ml">ml</option><option value="un">un</option></select></div>
            </div>
            <div class="form-row">
                <div class="field"><label>Custo por Unidade (R$)</label><input type="number" id="ing-custo" step="0.01" min="0" placeholder="0.00"></div>
                <div class="field"><label>Fornecedor</label><input type="text" id="ing-forn" placeholder="Opcional"></div>
            </div>
            <button type="submit" class="btn btn-p" style="width:100%;margin-top:0.5rem;"><span class="btn-text">üíæ Salvar</span></button>
        </form>
    </div></div>

    <div class="modal-bg" id="mod-confirm"><div class="modal" style="max-width:350px;">
        <div class="confirm-modal">
            <div class="confirm-icon" id="confirm-icon">‚ö†Ô∏è</div>
            <div class="confirm-title" id="confirm-title">Confirmar</div>
            <div class="confirm-text" id="confirm-text">Deseja continuar?</div>
            <div class="confirm-btns">
                <button class="btn btn-s" onclick="fecharModal('mod-confirm')">Cancelar</button>
                <button class="btn btn-d" id="confirm-btn">Confirmar</button>
            </div>
        </div>
    </div></div>

<script>
// ==================== CONFIG ====================
const API = '/api';

// ==================== DATABASE ====================
const DB = { 
    produtos: [], 
    massas: [],      // Massas premium com custo extra
    extras: [],      // Extras (bacon, queijo, etc)
    ingredientes: [], 
    fichas: [], 
    vendas: [] 
};

let importData = null, chart1 = null, chart2 = null;
let filterText = {};

// ==================== UTILS ====================
const $ = id => document.getElementById(id);
const R$ = v => 'R$ ' + (parseFloat(v)||0).toFixed(2).replace('.',',');
const pct = (a,b) => b > 0 ? ((a/b)*100).toFixed(1) : '0';

function toast(msg, err) { 
    $('toast-container').innerHTML = `<div class="toast ${err?'error':''}">${err?'‚ùå':'‚úÖ'} ${msg}</div>`; 
    setTimeout(() => $('toast-container').innerHTML = '', 3000); 
}

function showLoading(show) { 
    let el = $('loading-overlay'); 
    if(show && !el) { 
        el = document.createElement('div'); 
        el.id = 'loading-overlay'; 
        el.className = 'loading-overlay'; 
        el.innerHTML = '<div class="spinner"></div><div style="color:var(--text2);font-size:0.8rem;">Carregando...</div>'; 
        document.body.appendChild(el); 
    } else if(!show && el) el.remove(); 
}

function setBtnLoading(btn, loading) {
    if(loading) { btn.classList.add('btn-loading'); btn.disabled = true; }
    else { btn.classList.remove('btn-loading'); btn.disabled = false; }
}

function setSyncStatus(online) {
    const el = $('sync-status');
    el.className = 'sync-status ' + (online ? 'online' : 'offline');
    el.innerHTML = online ? '‚òÅÔ∏è Online' : '‚ö†Ô∏è Offline';
}

// ==================== API ====================
async function api(endpoint, method = 'GET', body = null) {
    try {
        const opts = { method, headers: { 'Content-Type': 'application/json' } };
        if (body) opts.body = JSON.stringify(body);
        const res = await fetch(API + '/' + endpoint, opts);
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
    } catch (e) {
        console.error('API Error:', e);
        setSyncStatus(false);
        throw e;
    }
}

// ==================== MODAL ====================
function abrirModal(id, editId) {
    const form = $(id).querySelector('form');
    if(form) {
        form.reset();
        const hidden = form.querySelector('input[type="hidden"]');
        if(hidden) hidden.value = '';
    }
    if(editId) preencherForm(id, editId);
    $(id).classList.add('show');
    document.body.style.overflow = 'hidden';
}

function fecharModal(id) {
    $(id).classList.remove('show');
    document.body.style.overflow = '';
}

function confirmarAcao(tipo, id) {
    const cfg = {
        'delete-prod': { icon: 'üóëÔ∏è', title: 'Excluir Produto?', text: 'Esta a√ß√£o n√£o pode ser desfeita.', action: () => execDelete('produtos', id) },
        'delete-massa': { icon: 'üóëÔ∏è', title: 'Excluir Massa?', text: 'Esta a√ß√£o n√£o pode ser desfeita.', action: () => execDelete('massas', id) },
        'delete-extra': { icon: 'üóëÔ∏è', title: 'Excluir Extra?', text: 'Esta a√ß√£o n√£o pode ser desfeita.', action: () => execDelete('extras', id) },
        'delete-ing': { icon: 'üóëÔ∏è', title: 'Excluir Ingrediente?', text: 'Esta a√ß√£o n√£o pode ser desfeita.', action: () => execDelete('ingredientes', id) },
        'delete-venda': { icon: 'üóëÔ∏è', title: 'Excluir Importa√ß√£o?', text: 'Os dados de venda ser√£o removidos.', action: () => execDelete('vendas', id) },
    }[tipo];
    if(!cfg) return;
    
    $('confirm-icon').textContent = cfg.icon;
    $('confirm-title').textContent = cfg.title;
    $('confirm-text').textContent = cfg.text;
    $('confirm-btn').onclick = () => { cfg.action(); fecharModal('mod-confirm'); };
    abrirModal('mod-confirm');
}

async function execDelete(tabela, id) {
    try {
        await api(tabela, 'DELETE', {id});
        DB[tabela] = DB[tabela].filter(x => x.id !== id);
        renderAll();
        toast('Exclu√≠do com sucesso!');
    } catch(e) { toast('Erro ao excluir!', true); }
}

function preencherForm(mid, id) {
    const m = { 
        'mod-prod': () => { 
            const p = DB.produtos.find(x=>x.id===id); 
            if(p){ 
                $('prod-id').value=id; 
                $('prod-nome').value=p.nome; 
                $('prod-cat').value=p.cat||'macarrao'; 
                $('prod-custo-p').value=p.custo_p||''; 
                $('prod-custo-g').value=p.custo_g||''; 
                $('prod-preco-p').value=p.preco_p||''; 
                $('prod-preco-g').value=p.preco_g||''; 
            }
        },
        'mod-massa': () => { 
            const m = DB.massas.find(x=>x.id===id); 
            if(m){ 
                $('massa-id').value=id; 
                $('massa-nome').value=m.nome; 
                $('massa-custo-if').value=m.custo_ifood||''; 
                $('massa-custo-an').value=m.custo_anota||''; 
            }
        },
        'mod-extra': () => { 
            const e = DB.extras.find(x=>x.id===id); 
            if(e){ $('extra-id').value=id; $('extra-nome').value=e.nome; $('extra-custo').value=e.custo||''; }
        },
        'mod-ing': () => { 
            const i = DB.ingredientes.find(x=>x.id===id); 
            if(i){ $('ing-id').value=id; $('ing-nome').value=i.nome; $('ing-un').value=i.un; $('ing-custo').value=i.custo; $('ing-forn').value=i.forn||''; }
        },
    }; 
    if(m[mid]) m[mid]();
}

// ==================== LOAD DATA ====================
async function loadAll() {
    showLoading(true);
    try {
        DB.produtos = await api('produtos');
        DB.massas = await api('massas');
        DB.extras = await api('extras');
        DB.ingredientes = await api('ingredientes');
        DB.fichas = await api('fichas');
        DB.vendas = await api('vendas');
        setSyncStatus(true);
        renderAll();
        atualizarStats();
    } catch (e) {
        console.error(e);
        toast('Erro ao carregar dados!', true);
    }
    showLoading(false);
}

// ==================== NAVIGATION ====================
document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        $('p-' + btn.dataset.p).classList.add('active');
        localStorage.setItem('cmv_tab', btn.dataset.p);
    };
});

// ==================== FILTERING ====================
function filtrarProd() { filterText.produtos = $('search-prod').value.toLowerCase(); renderProd(); }
function filtrarExtra() { filterText.extras = $('search-extra').value.toLowerCase(); renderExtra(); }
function filtrarIng() { filterText.ingredientes = $('search-ing').value.toLowerCase(); renderIng(); }

function getFiltered(arr, tabela) {
    const txt = filterText[tabela];
    if(!txt) return arr;
    return arr.filter(x => x.nome.toLowerCase().includes(txt));
}

// ==================== RENDERS ====================
function renderProd() { 
    let data = getFiltered(DB.produtos, 'produtos');
    $('tbl-prod').innerHTML = data.length === 0 ? '<tr><td colspan="5"><div class="empty"><div class="empty-icon">üçΩÔ∏è</div>Nenhum produto</div></td></tr>' : 
    data.map(p => {
        const catBadge = {macarrao:'blue',risoto:'orange',nhoque:'pink',outros:'cyan'}[p.cat]||'cyan';
        return `<tr>
            <td><b>${p.nome}</b></td>
            <td><span class="badge ${catBadge}">${(p.cat||'').slice(0,3)}</span></td>
            <td class="mono">${p.custo_p>0?R$(p.custo_p):'-'}</td>
            <td class="mono">${p.custo_g>0?R$(p.custo_g):'-'}</td>
            <td class="actions">
                <button class="btn btn-e btn-sm" onclick="abrirModal('mod-prod',${p.id})">‚úèÔ∏è</button>
                <button class="btn btn-d btn-sm" onclick="confirmarAcao('delete-prod',${p.id})">üóëÔ∏è</button>
            </td>
        </tr>`;
    }).join(''); 
}

function renderMassa() { 
    $('tbl-massa').innerHTML = DB.massas.length === 0 ? '<tr><td colspan="4"><div class="empty"><div class="empty-icon">üçù</div>Nenhuma massa premium</div></td></tr>' : 
    DB.massas.map(m => `<tr>
        <td><b>${m.nome}</b></td>
        <td class="mono"><span class="cardapio-tag ifood">+${R$(m.custo_ifood||0)}</span></td>
        <td class="mono"><span class="cardapio-tag anotaai">+${R$(m.custo_anota||0)}</span></td>
        <td class="actions">
            <button class="btn btn-e btn-sm" onclick="abrirModal('mod-massa',${m.id})">‚úèÔ∏è</button>
            <button class="btn btn-d btn-sm" onclick="confirmarAcao('delete-massa',${m.id})">üóëÔ∏è</button>
        </td>
    </tr>`).join(''); 
}

function renderExtra() { 
    let data = getFiltered(DB.extras, 'extras');
    $('tbl-extra').innerHTML = data.length === 0 ? '<tr><td colspan="3"><div class="empty"><div class="empty-icon">‚ûï</div>Nenhum extra</div></td></tr>' : 
    data.map(e => `<tr>
        <td><b>${e.nome}</b></td>
        <td class="mono">${R$(e.custo||0)}</td>
        <td class="actions">
            <button class="btn btn-e btn-sm" onclick="abrirModal('mod-extra',${e.id})">‚úèÔ∏è</button>
            <button class="btn btn-d btn-sm" onclick="confirmarAcao('delete-extra',${e.id})">üóëÔ∏è</button>
        </td>
    </tr>`).join(''); 
}

function renderIng() { 
    let data = getFiltered(DB.ingredientes, 'ingredientes');
    $('tbl-ing').innerHTML = data.length === 0 ? '<tr><td colspan="5"><div class="empty"><div class="empty-icon">üßÖ</div>Nenhum ingrediente</div></td></tr>' : 
    data.map(i => `<tr>
        <td><b>${i.nome}</b></td>
        <td>${i.un}</td>
        <td class="mono">${R$(i.custo)}</td>
        <td>${i.forn||'-'}</td>
        <td class="actions">
            <button class="btn btn-e btn-sm" onclick="abrirModal('mod-ing',${i.id})">‚úèÔ∏è</button>
            <button class="btn btn-d btn-sm" onclick="confirmarAcao('delete-ing',${i.id})">üóëÔ∏è</button>
        </td>
    </tr>`).join(''); 
}

function renderMeses() { 
    $('tbl-meses').innerHTML = DB.vendas.length === 0 ? '<tr><td colspan="6"><div class="empty"><div class="empty-icon">üìÖ</div>Nenhuma importa√ß√£o</div></td></tr>' : 
    DB.vendas.map(v => { 
        const cmv = v.total_fat > 0 ? ((v.total_custo/v.total_fat)*100).toFixed(0) : '0'; 
        return `<tr>
            <td><b>${v.mes}/${v.ano}</b></td>
            <td><span class="cardapio-tag ${v.cardapio}">${v.cardapio==='ifood'?'iFood':'AnotaAi'}</span></td>
            <td class="mono">${R$(v.total_fat)}</td>
            <td class="mono">${R$(v.total_custo)}</td>
            <td><span class="badge ${cmv<=30?'green':cmv<=40?'yellow':'red'}">${cmv}%</span></td>
            <td class="actions"><button class="btn btn-d btn-sm" onclick="confirmarAcao('delete-venda',${v.id})">üóëÔ∏è</button></td>
        </tr>`; 
    }).join(''); 
    atualizarSelectsMeses(); 
}

function atualizarSelectsMeses() {
    const opts = '<option value="">Selecione per√≠odo...</option>' + DB.vendas.map(v => 
        `<option value="${v.id}">${v.mes}/${v.ano} - ${v.cardapio==='ifood'?'iFood':'AnotaAi'}</option>`
    ).join('');
    $('sel-mes').innerHTML = opts;
}

function atualizarFichaSelects() {
    $('ficha-prod').innerHTML = '<option value="">Selecione...</option>' + DB.produtos.map(p => 
        `<option value="${p.id}">${p.nome}</option>`
    ).join('');
    $('ficha-ing').innerHTML = '<option value="">Ingrediente...</option>' + DB.ingredientes.map(i => 
        `<option value="${i.id}" data-un="${i.un}">${i.nome} (${R$(i.custo)}/${i.un})</option>`
    ).join('');
}

function atualizarStats() {
    $('stat-prod').textContent = DB.produtos.length;
    $('stat-ing').textContent = DB.ingredientes.length;
    $('stat-extra').textContent = DB.extras.length;
    $('stat-vendas').textContent = DB.vendas.length;
}

// ==================== FORMS ====================
async function submitForm(formId, tabela, getData, modalId) {
    const form = $(formId);
    const btn = form.querySelector('button[type="submit"]');
    const idField = form.querySelector('input[type="hidden"]');
    const idValue = idField ? idField.value.trim() : '';
    const id = idValue ? parseInt(idValue) : null;
    
    setBtnLoading(btn, true);
    try {
        const d = getData();
        if(id && !isNaN(id) && id > 0) {
            const r = await api(tabela, 'PUT', {...d, id});
            const i = DB[tabela].findIndex(x => x.id === id);
            if(i >= 0) DB[tabela][i] = r;
        } else {
            const r = await api(tabela, 'POST', d);
            DB[tabela].push(r);
        }
        renderAll();
        fecharModal(modalId);
        toast('Salvo com sucesso!');
    } catch(e) {
        toast('Erro ao salvar: ' + e.message, true);
    }
    setBtnLoading(btn, false);
}

$('form-prod').onsubmit = function(e) { 
    e.preventDefault(); 
    const nome = $('prod-nome').value.trim();
    if(!nome) { toast('Preencha o nome!', true); return; }
    submitForm('form-prod', 'produtos', () => ({
        nome, 
        cat: $('prod-cat').value,
        custo_p: parseFloat($('prod-custo-p').value)||0, 
        custo_g: parseFloat($('prod-custo-g').value)||0,
        preco_p: parseFloat($('prod-preco-p').value)||0, 
        preco_g: parseFloat($('prod-preco-g').value)||0
    }), 'mod-prod');
};

$('form-massa').onsubmit = function(e) { 
    e.preventDefault(); 
    const nome = $('massa-nome').value.trim();
    if(!nome) { toast('Preencha o nome!', true); return; }
    submitForm('form-massa', 'massas', () => ({
        nome, 
        custo_ifood: parseFloat($('massa-custo-if').value)||0, 
        custo_anota: parseFloat($('massa-custo-an').value)||0
    }), 'mod-massa');
};

$('form-extra').onsubmit = function(e) { 
    e.preventDefault(); 
    const nome = $('extra-nome').value.trim();
    if(!nome) { toast('Preencha o nome!', true); return; }
    submitForm('form-extra', 'extras', () => ({
        nome, 
        custo: parseFloat($('extra-custo').value)||0
    }), 'mod-extra');
};

$('form-ing').onsubmit = function(e) { 
    e.preventDefault(); 
    const nome = $('ing-nome').value.trim();
    if(!nome) { toast('Preencha o nome!', true); return; }
    submitForm('form-ing', 'ingredientes', () => ({
        nome, 
        un: $('ing-un').value, 
        custo: parseFloat($('ing-custo').value)||0, 
        forn: $('ing-forn').value.trim()
    }), 'mod-ing');
};

// ==================== FICHAS T√âCNICAS ====================
function carregarFicha() {
    const prodId = $('ficha-prod').value;
    if(!prodId) { $('ficha-area').style.display = 'none'; return; }
    $('ficha-area').style.display = 'block';
    renderFichaIngs();
}

function renderFichaIngs() {
    const prodId = parseInt($('ficha-prod').value);
    const tam = $('ficha-tam').value;
    const fichaItems = DB.fichas.filter(f => f.produto_id === prodId && f.tamanho === tam);
    
    $('ficha-list').innerHTML = fichaItems.length === 0 ? 
        '<div class="empty" style="padding:0.5rem;font-size:0.7rem;">Nenhum ingrediente adicionado</div>' : 
        fichaItems.map(fi => {
            const ing = DB.ingredientes.find(i => i.id === fi.ingrediente_id);
            if(!ing) return '';
            const custo = parseFloat(ing.custo) * parseFloat(fi.qtd);
            return `<div class="ing-item">
                <div><b>${ing.nome}</b> <span style="color:var(--text3);">${fi.qtd} ${fi.un||ing.un}</span></div>
                <div style="display:flex;align-items:center;gap:0.3rem;">
                    <span class="mono" style="color:var(--green);">${R$(custo)}</span>
                    <button class="btn btn-d btn-sm" onclick="remIngFicha(${fi.id})" style="padding:0.2rem 0.4rem;">√ó</button>
                </div>
            </div>`;
        }).join('');
    
    calcFicha();
}

async function addIngFicha() {
    const prodId = parseInt($('ficha-prod').value);
    const tam = $('ficha-tam').value;
    const ingId = parseInt($('ficha-ing').value);
    const qtd = parseFloat($('ficha-qtd').value);
    const un = $('ficha-un').value;
    
    if(!prodId || !ingId || !qtd || qtd <= 0) { 
        toast('Preencha todos os campos!', true); 
        return; 
    }
    
    try {
        await api('fichas', 'POST', { produto_id: prodId, tamanho: tam, ingrediente_id: ingId, qtd, un });
        DB.fichas = await api('fichas');
        $('ficha-qtd').value = '';
        renderFichaIngs();
        toast('Ingrediente adicionado!');
    } catch(e) { 
        toast('Erro ao adicionar!', true); 
    }
}

async function remIngFicha(id) {
    try {
        await api('fichas', 'DELETE', { id });
        DB.fichas = DB.fichas.filter(f => f.id !== id);
        renderFichaIngs();
    } catch(e) { 
        toast('Erro ao remover!', true); 
    }
}

function calcFicha() {
    const prodId = parseInt($('ficha-prod').value);
    const tam = $('ficha-tam').value;
    const prod = DB.produtos.find(p => p.id === prodId);
    if(!prod) return;
    
    const fichaItems = DB.fichas.filter(f => f.produto_id === prodId && f.tamanho === tam);
    let custoIng = 0;
    
    fichaItems.forEach(fi => {
        const ing = DB.ingredientes.find(i => i.id === fi.ingrediente_id);
        if(ing) custoIng += parseFloat(ing.custo) * parseFloat(fi.qtd);
    });
    
    const preco = tam === 'P' ? parseFloat(prod.preco_p)||0 : parseFloat(prod.preco_g)||0;
    const cmv = preco > 0 ? (custoIng / preco) * 100 : 0;
    
    $('f-cing').textContent = R$(custoIng);
    $('f-ctotal').textContent = R$(custoIng);
    $('f-preco').textContent = R$(preco);
    $('f-cmv').textContent = cmv.toFixed(1) + '%';
    $('f-cmv').style.color = cmv <= 30 ? 'var(--green)' : cmv <= 40 ? 'var(--yellow)' : 'var(--red)';
}

async function salvarCustoProduto() {
    const prodId = parseInt($('ficha-prod').value);
    const tam = $('ficha-tam').value;
    const prod = DB.produtos.find(p => p.id === prodId);
    if(!prod) return;
    
    const fichaItems = DB.fichas.filter(f => f.produto_id === prodId && f.tamanho === tam);
    let custoTotal = 0;
    fichaItems.forEach(fi => {
        const ing = DB.ingredientes.find(i => i.id === fi.ingrediente_id);
        if(ing) custoTotal += parseFloat(ing.custo) * parseFloat(fi.qtd);
    });
    
    const updateData = { 
        id: prodId, 
        nome: prod.nome, 
        cat: prod.cat,
        custo_p: tam === 'P' ? custoTotal : prod.custo_p,
        custo_g: tam === 'G' ? custoTotal : prod.custo_g,
        preco_p: prod.preco_p,
        preco_g: prod.preco_g
    };
    
    try {
        const r = await api('produtos', 'PUT', updateData);
        const i = DB.produtos.findIndex(x => x.id === prodId);
        if(i >= 0) DB.produtos[i] = r;
        renderProd();
        toast(`Custo Box ${tam} salvo: ${R$(custoTotal)}`);
    } catch(e) {
        toast('Erro ao salvar!', true);
    }
}

// ==================== IMPORT EXCEL ====================
const uploadBox = $('upload-box'), fileInput = $('file-input');
uploadBox.onclick = () => fileInput.click();
uploadBox.ondragover = e => { e.preventDefault(); uploadBox.classList.add('dragover'); };
uploadBox.ondragleave = () => uploadBox.classList.remove('dragover');
uploadBox.ondrop = e => { e.preventDefault(); uploadBox.classList.remove('dragover'); if(e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); };
fileInput.onchange = e => { if(e.target.files[0]) processFile(e.target.files[0]); };

function processFile(file) {
    $('upload-file').textContent = 'üìÑ ' + file.name;
    uploadBox.classList.add('has-file');
    showLoading(true);
    
    const reader = new FileReader();
    reader.onload = ev => { 
        try { 
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'}); 
            processarExcel(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1})); 
        } catch(e) { 
            toast('Erro ao processar arquivo!', true); 
            console.error(e);
        } 
        showLoading(false); 
    };
    reader.onerror = () => { showLoading(false); toast('Erro ao ler arquivo!', true); };
    reader.readAsArrayBuffer(file);
}

function processarExcel(data) {
    // Detectar per√≠odo
    let periodoDetectado = '';
    if(data[1] && data[1][0]) {
        const txt = String(data[1][0]);
        const match = txt.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        if(match) periodoDetectado = match[2] + '/' + match[3];
    }
    
    // Processar linhas
    const vendas = { 
        produtos: [],  // { nome, tamanho, qtd, faturamento }
        massas: [],    // { nome, qtd }
        extras: [],    // { nome, qtd, valor }
        totalQtd: 0, 
        totalFat: 0 
    };
    
    let produtoAtual = null;
    
    for(let i = 5; i < data.length; i++) {
        const row = data[i];
        if(!row || row[0] === undefined) continue;
        
        const rawNome = String(row[0]).trim();
        const qty = parseInt(row[1]) || 0;
        const valor = parseFloat(row[2]) || 0;
        
        if(!rawNome || rawNome === 'nan') continue;
        
        const isSubItem = rawNome.startsWith('-') || rawNome.startsWith(' ');
        const nome = rawNome.replace(/^[\s\-]+/, '').trim();
        const nl = nome.toLowerCase();
        
        if(!isSubItem && qty > 0) {
            // √â um produto/categoria principal
            vendas.totalFat += valor;
            vendas.totalQtd += qty;
            produtoAtual = nome;
        } else if(isSubItem && qty > 0) {
            // √â um subitem
            // Verificar se √© Box P ou Box G
            if(nl.includes('box p') || nl.includes('450g')) {
                vendas.produtos.push({ nome: produtoAtual, tamanho: 'P', qtd: qty, fat: valor });
            } else if(nl.includes('box g') || nl.includes('800g') || nl.includes('750g') || nl.includes('650g')) {
                vendas.produtos.push({ nome: produtoAtual, tamanho: 'G', qtd: qty, fat: valor });
            }
            // Verificar se √© massa
            else if(nl.includes('talharim') || nl.includes('penne') || nl.includes('caracolino') || 
                    nl.includes('espaguete') || nl.includes('integral') || nl.includes('proteico') ||
                    nl.includes('nhoque tradicional') || nl.includes('nhoque recheado')) {
                vendas.massas.push({ nome, qtd: qty });
            }
            // Verificar se √© extra
            else if(nl.includes('extra ') && valor > 0) {
                vendas.extras.push({ nome, qtd: qty, valor });
            }
        }
    }
    
    importData = { periodoDetectado, vendas };
    mostrarPreview();
}

function mostrarPreview() {
    const v = importData.vendas;
    const meses = ['','Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    const anoAtual = new Date().getFullYear();
    
    let mesOpts = meses.map((m,i) => i > 0 ? `<option value="${String(i).padStart(2,'0')}" ${importData.periodoDetectado.startsWith(String(i).padStart(2,'0')) ? 'selected' : ''}>${m}</option>` : '').join('');
    let anoOpts = ''; for(let a = anoAtual - 2; a <= anoAtual + 1; a++) anoOpts += `<option value="${a}" ${importData.periodoDetectado.includes(String(a)) ? 'selected' : ''}>${a}</option>`;
    
    $('import-preview').innerHTML = `
        <div class="preview">
            <div class="form-row" style="margin-bottom:0.6rem;">
                <div class="field"><label>M√™s</label><select id="import-mes">${mesOpts}</select></div>
                <div class="field"><label>Ano</label><select id="import-ano">${anoOpts}</select></div>
                <div class="field"><label>Card√°pio *</label><select id="import-cardapio"><option value="">Selecione</option><option value="ifood">üì± iFood</option><option value="anotaai">üì≤ AnotaAi</option></select></div>
            </div>
            <div class="res-box" style="margin-bottom:0.5rem;grid-template-columns:repeat(4,1fr);">
                <div class="res-item"><div class="lbl">Produtos</div><div class="val" style="color:var(--blue);">${v.produtos.length}</div></div>
                <div class="res-item"><div class="lbl">Massas</div><div class="val" style="color:var(--orange);">${v.massas.length}</div></div>
                <div class="res-item"><div class="lbl">Extras</div><div class="val" style="color:var(--purple);">${v.extras.length}</div></div>
                <div class="res-item"><div class="lbl">Faturamento</div><div class="val" style="color:var(--green);">${R$(v.totalFat)}</div></div>
            </div>
            <div style="display:flex;gap:0.4rem;">
                <button class="btn btn-p" style="flex:1;" onclick="confirmarImport()">‚úÖ Calcular CMV e Importar</button>
                <button class="btn btn-s" onclick="cancelarImport()">‚ùå</button>
            </div>
        </div>
    `;
}

async function confirmarImport() {
    const mes = $('import-mes').value;
    const ano = $('import-ano').value;
    const cardapio = $('import-cardapio').value;
    
    if(!mes || !ano || !cardapio) { 
        toast('Preencha m√™s, ano e card√°pio!', true); 
        return; 
    }
    
    showLoading(true);
    const v = importData.vendas;
    
    // ============ C√ÅLCULO DO CMV REAL ============
    let custoTotal = 0;
    let detalhes = [];
    
    // 1. Custo dos produtos (Box P e Box G)
    v.produtos.forEach(prod => {
        const dbProd = DB.produtos.find(p => 
            prod.nome && prod.nome.toLowerCase().includes(p.nome.toLowerCase())
        );
        if(dbProd) {
            const custo = prod.tamanho === 'P' ? 
                (parseFloat(dbProd.custo_p)||0) : 
                (parseFloat(dbProd.custo_g)||0);
            const custoItem = custo * prod.qtd;
            custoTotal += custoItem;
            detalhes.push({ tipo: 'produto', nome: `${dbProd.nome} Box ${prod.tamanho}`, qtd: prod.qtd, custo: custoItem });
        }
    });
    
    // 2. Custo das massas premium
    v.massas.forEach(massa => {
        const ml = massa.nome.toLowerCase();
        const dbMassa = DB.massas.find(m => ml.includes(m.nome.toLowerCase()));
        if(dbMassa) {
            const custo = cardapio === 'ifood' ? 
                (parseFloat(dbMassa.custo_ifood)||0) : 
                (parseFloat(dbMassa.custo_anota)||0);
            const custoItem = custo * massa.qtd;
            custoTotal += custoItem;
            detalhes.push({ tipo: 'massa', nome: dbMassa.nome, qtd: massa.qtd, custo: custoItem });
        }
    });
    
    // 3. Custo dos extras
    v.extras.forEach(extra => {
        const el = extra.nome.toLowerCase();
        const dbExtra = DB.extras.find(e => el.includes(e.nome.toLowerCase()));
        if(dbExtra) {
            const custoItem = (parseFloat(dbExtra.custo)||0) * extra.qtd;
            custoTotal += custoItem;
            detalhes.push({ tipo: 'extra', nome: dbExtra.nome, qtd: extra.qtd, custo: custoItem });
        }
    });
    
    try {
        await api('vendas', 'POST', {
            mes, ano, cardapio,
            grupos: v.produtos,
            massas: v.massas,
            extras: v.extras,
            detalhes_cmv: detalhes,
            total_qtd: v.totalQtd,
            total_fat: v.totalFat,
            total_custo: custoTotal
        });
        
        DB.vendas = await api('vendas');
        
        const cmvPct = v.totalFat > 0 ? ((custoTotal/v.totalFat)*100).toFixed(1) : '0';
        toast(`Importado! CMV: ${cmvPct}% (${R$(custoTotal)})`);
        
        cancelarImport();
        renderMeses();
        atualizarDash();
    } catch(e) { 
        toast('Erro ao importar: ' + e.message, true); 
    }
    showLoading(false);
}

function cancelarImport() {
    importData = null;
    $('import-preview').innerHTML = '';
    $('file-input').value = '';
    $('upload-file').textContent = '';
    uploadBox.classList.remove('has-file');
}

// ==================== AN√ÅLISE ====================
$('sel-mes').onchange = function() {
    const id = parseInt(this.value);
    const v = DB.vendas.find(x => x.id === id);
    if(!v) { $('analise-area').innerHTML = ''; return; }
    
    const cmv = v.total_fat > 0 ? ((v.total_custo/v.total_fat)*100).toFixed(1) : '0';
    const lucro = v.total_fat - v.total_custo;
    
    // Tentar parsear detalhes
    let detalhes = [];
    try {
        detalhes = typeof v.detalhes_cmv === 'string' ? JSON.parse(v.detalhes_cmv) : (v.detalhes_cmv || []);
    } catch(e) {}
    
    $('analise-area').innerHTML = `
        <div class="alert ${v.cardapio==='ifood'?'info':'ok'}">
            üìä ${v.mes}/${v.ano} - <span class="cardapio-tag ${v.cardapio}">${v.cardapio==='ifood'?'iFood':'AnotaAi'}</span>
        </div>
        <div class="grid-kpi" style="grid-template-columns:repeat(4,1fr);">
            <div class="kpi green"><div class="kpi-label">Faturamento</div><div class="kpi-value">${R$(v.total_fat)}</div></div>
            <div class="kpi blue"><div class="kpi-label">Custo Real</div><div class="kpi-value">${R$(v.total_custo)}</div></div>
            <div class="kpi ${cmv<=30?'green':cmv<=40?'yellow':'red'}"><div class="kpi-label">CMV</div><div class="kpi-value">${cmv}%</div></div>
            <div class="kpi purple"><div class="kpi-label">Lucro Bruto</div><div class="kpi-value">${R$(lucro)}</div></div>
        </div>
        ${detalhes.length > 0 ? `
        <div class="card">
            <div class="card-title">üìã Detalhamento do Custo</div>
            <div class="tbl-wrap" style="margin-top:0.5rem;">
                <table>
                    <thead><tr><th>Tipo</th><th>Item</th><th>Qtd</th><th>Custo</th></tr></thead>
                    <tbody>
                        ${detalhes.slice(0,20).map(d => `
                            <tr>
                                <td><span class="badge ${d.tipo==='produto'?'blue':d.tipo==='massa'?'orange':'purple'}">${d.tipo}</span></td>
                                <td><b>${d.nome}</b></td>
                                <td class="mono">${d.qtd}</td>
                                <td class="mono">${R$(d.custo)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        ` : ''}
    `;
};

// ==================== DASHBOARD ====================
function atualizarDash() {
    if(DB.vendas.length === 0) {
        $('k-fat').textContent = 'R$ 0'; 
        $('k-custo').textContent = 'R$ 0'; 
        $('k-cmv').textContent = '0%'; 
        $('k-lucro').textContent = 'R$ 0'; 
        $('k-itens').textContent = '0';
        $('tbl-dash').innerHTML = '<tr><td colspan="5"><div class="empty"><div class="empty-icon">üìä</div>Importe vendas para ver dados</div></td></tr>';
        if(chart1) { chart1.destroy(); chart1 = null; } 
        if(chart2) { chart2.destroy(); chart2 = null; }
        return;
    }
    
    const v = DB.vendas[DB.vendas.length - 1];
    
    $('k-fat').textContent = R$(v.total_fat); 
    $('k-custo').textContent = R$(v.total_custo);
    const cmv = v.total_fat > 0 ? ((v.total_custo/v.total_fat)*100) : 0;
    $('k-cmv').textContent = cmv.toFixed(0) + '%'; 
    $('k-lucro').textContent = R$(v.total_fat - v.total_custo); 
    $('k-itens').textContent = v.total_qtd || 0;
    
    // Tabela de vendas
    $('tbl-dash').innerHTML = DB.vendas.slice(-5).reverse().map(vd => {
        const cmvPct = vd.total_fat > 0 ? ((vd.total_custo/vd.total_fat)*100).toFixed(0) : '0';
        return `<tr>
            <td><b>${vd.mes}/${vd.ano}</b></td>
            <td><span class="cardapio-tag ${vd.cardapio}">${vd.cardapio==='ifood'?'iF':'An'}</span></td>
            <td class="mono">${R$(vd.total_fat)}</td>
            <td class="mono">${R$(vd.total_custo)}</td>
            <td><span class="badge ${cmvPct<=30?'green':cmvPct<=40?'yellow':'red'}">${cmvPct}%</span></td>
        </tr>`;
    }).join('');
    
    atualizarCharts();
}

function atualizarCharts() {
    // Chart 1 - Produtos mais vendidos (placeholder)
    if(chart1) chart1.destroy();
    const labels1 = DB.produtos.slice(0,5).map(p => p.nome.slice(0,10));
    const valores1 = DB.produtos.slice(0,5).map(p => parseFloat(p.custo_g)||0);
    
    chart1 = new Chart($('chart1'), {
        type: 'bar', 
        data: { 
            labels: labels1, 
            datasets: [{ data: valores1, backgroundColor: ['#10b981','#3b82f6','#f59e0b','#8b5cf6','#ec4899'], borderRadius: 4 }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { legend: { display: false } }, 
            scales: { 
                y: { ticks: { color: '#64748b', font: { size: 9 } } }, 
                x: { ticks: { color: '#94a3b8', maxRotation: 45, font: { size: 8 } } } 
            } 
        }
    });
    
    // Chart 2 - CMV por m√™s
    if(DB.vendas.length >= 1) {
        const ultimos = DB.vendas.slice(-6);
        const labels2 = ultimos.map(v => `${v.mes}/${v.ano.slice(-2)}`);
        const cmvData = ultimos.map(v => v.total_fat > 0 ? ((v.total_custo/v.total_fat)*100).toFixed(1) : 0);
        
        if(chart2) chart2.destroy();
        chart2 = new Chart($('chart2'), {
            type: 'line', 
            data: { 
                labels: labels2, 
                datasets: [{ 
                    label: 'CMV %', 
                    data: cmvData, 
                    borderColor: '#f59e0b', 
                    backgroundColor: 'rgba(245,158,11,0.1)', 
                    fill: true, 
                    tension: 0.3 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { ticks: { color: '#64748b', font: { size: 9 }, callback: v => v + '%' } }, 
                    x: { ticks: { color: '#94a3b8', font: { size: 8 } } } 
                } 
            }
        });
    }
}

// ==================== CONFIG ====================
async function setupDB() {
    if(!confirm('Criar/atualizar tabelas no banco de dados?')) return;
    showLoading(true);
    try {
        await api('setup', 'POST');
        toast('Tabelas criadas com sucesso!');
    } catch(e) { toast('Erro: ' + e.message, true); }
    showLoading(false);
}

async function seedDB() {
    if(!confirm('Carregar dados iniciais? (massas premium e extras comuns)')) return;
    showLoading(true);
    try {
        await api('seed', 'POST');
        await loadAll();
        toast('Dados iniciais carregados!');
    } catch(e) { toast('Erro: ' + e.message, true); }
    showLoading(false);
}

function exportarBackup() {
    const backup = { versao: '10.0', data: new Date().toISOString(), dados: DB };
    const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_cmv_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Backup exportado!');
}

// ==================== INIT ====================
function renderAll() { 
    renderProd();
    renderMassa();
    renderExtra();
    renderIng();
    renderMeses();
    atualizarFichaSelects();
    atualizarDash();
}

document.addEventListener('DOMContentLoaded', () => {
    $('dataAtual').textContent = new Date().toLocaleDateString('pt-BR');
    
    // Restaurar aba
    const savedTab = localStorage.getItem('cmv_tab');
    if(savedTab) {
        const btn = document.querySelector(`.nav-btn[data-p="${savedTab}"]`);
        if(btn) btn.click();
    }
    
    // Fechar modais
    document.querySelectorAll('.modal-bg').forEach(m => { 
        m.onclick = e => { if(e.target === m) fecharModal(m.id); }; 
    });
    
    // ESC fecha modal
    document.addEventListener('keydown', e => {
        if(e.key === 'Escape') {
            document.querySelectorAll('.modal-bg.show').forEach(m => fecharModal(m.id));
        }
    });
    
    loadAll();
});
</script>
</body>
</html>
